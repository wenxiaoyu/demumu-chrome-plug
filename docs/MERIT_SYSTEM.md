# 功德值系统详解

## 📖 概述

功德值是"还活着吗"插件的核心系统之一。不同于简单的"每次+1"，我们设计了一个多维度的功德累积算法，让每次敲击都有不同的价值。

## 🎯 设计目标

1. **鼓励每日打卡**：通过每日首次加成和连续天数加成
2. **奖励活跃用户**：通过连击加成和里程碑奖励
3. **长期激励**：功德值永不减少，持续累积
4. **公平合理**：各种加成有上限，避免过度刷分

## 🧮 计算公式

```
总功德 = 基础功德 + 每日首次加成 + 连击加成 + 连续天数加成 + 里程碑奖励
```

## 📊 各项加成详解

### 1. 基础功德

**规则**：每次敲击固定获得
**数值**：+1 功德
**说明**：这是最基础的奖励，无论何时敲击都会获得

**示例**：
```
敲击1次 → +1 功德
敲击10次 → +10 功德
```

### 2. 每日首次加成

**规则**：每天第一次敲击时获得
**数值**：+5 功德
**重置时间**：每天 0:00（午夜）
**说明**：鼓励用户每天至少敲击一次

**示例**：
```
今天第1次敲击 → 1（基础）+ 5（首次）= 6 功德
今天第2次敲击 → 1（基础）= 1 功德
明天第1次敲击 → 1（基础）+ 5（首次）= 6 功德
```

### 3. 连击加成

**规则**：在时间窗口内连续敲击
**时间窗口**：3秒
**加成规则**：
- 第1次连击：+1 功德
- 第2次连击：+2 功德
- 第3次连击：+3 功德
- 第4次连击：+4 功德
- 第5次及以上：+5 功德（上限）

**说明**：
- 超过3秒未敲击，连击数重置为0
- 连击加成最多+5，避免无限刷分

**示例**：
```
第1次敲击 → 1（基础）= 1 功德
第2次敲击（2秒后）→ 1（基础）+ 1（连击）= 2 功德
第3次敲击（2秒后）→ 1（基础）+ 2（连击）= 3 功德
第4次敲击（2秒后）→ 1（基础）+ 3（连击）= 4 功德
第5次敲击（2秒后）→ 1（基础）+ 4（连击）= 5 功德
第6次敲击（2秒后）→ 1（基础）+ 5（连击）= 6 功德
第7次敲击（2秒后）→ 1（基础）+ 5（连击）= 6 功德（达到上限）
...
第N次敲击（5秒后）→ 1（基础）= 1 功德（连击中断）
```

### 4. 连续天数加成

**规则**：连续多天打卡获得加成
**计算公式**：连续天数 × 0.5
**上限**：+10 功德
**说明**：
- 每天至少敲击一次才算连续
- 中断后重新计数
- 达到20天后保持+10加成

**示例**：
```
连续1天 → +0.5 功德
连续2天 → +1 功德
连续5天 → +2.5 功德
连续10天 → +5 功德
连续15天 → +7.5 功德
连续20天 → +10 功德（达到上限）
连续30天 → +10 功德（保持上限）
```

### 5. 里程碑奖励

**规则**：总敲击次数达到特定值时获得
**奖励表**：

| 里程碑 | 奖励功德 | 说明 |
|-------|---------|------|
| 10次  | +10     | 初学者 |
| 50次  | +50     | 入门 |
| 100次 | +100    | 小成 |
| 500次 | +500    | 有成 |
| 1000次| +1000   | 大成 |
| 5000次| +5000   | 圆满 |

**说明**：
- 每个里程碑只能获得一次
- 奖励在达到里程碑的那次敲击时发放
- 跨越多个里程碑时，所有奖励累加

**示例**：
```
第9次敲击 → 正常功德
第10次敲击 → 正常功德 + 10（里程碑）
第11次敲击 → 正常功德

第99次敲击 → 正常功德
第100次敲击 → 正常功德 + 100（里程碑）
第101次敲击 → 正常功德
```

## 🎮 实际场景示例

### 场景1：新用户首次使用

```
用户A，第一天使用：
- 第1次敲击：1（基础）+ 5（首次）= 6 功德
- 第2次敲击（2秒后）：1（基础）+ 1（连击）= 2 功德
- 第3次敲击（2秒后）：1（基础）+ 2（连击）= 3 功德
- 第10次敲击（连击中）：1（基础）+ 5（连击）+ 10（里程碑）= 16 功德

当天总功德：约 60 功德
```

### 场景2：连续打卡用户

```
用户B，连续打卡10天：
- 每天首次敲击：1（基础）+ 5（首次）+ 5（连续10天）= 11 功德
- 每天其他敲击：1（基础）+ 5（连续10天）= 6 功德

如果每天敲击10次：
- 首次：11 功德
- 其他9次：54 功德（平均6功德/次）
- 每天总计：65 功德
- 10天总计：650 功德
```

### 场景3：冲刺里程碑

```
用户C，已有95次敲击，冲刺100次：
- 第96次：1（基础）+ 其他加成 = X 功德
- 第97次：1（基础）+ 其他加成 = X 功德
- 第98次：1（基础）+ 其他加成 = X 功德
- 第99次：1（基础）+ 其他加成 = X 功德
- 第100次：1（基础）+ 其他加成 + 100（里程碑）= X + 100 功德

里程碑奖励让这次敲击特别有价值！
```

### 场景4：连击高手

```
用户D，快速连击20次（每次间隔2秒）：
- 第1次：1（基础）= 1 功德
- 第2次：1（基础）+ 1（连击）= 2 功德
- 第3次：1（基础）+ 2（连击）= 3 功德
- 第4次：1（基础）+ 3（连击）= 4 功德
- 第5次：1（基础）+ 4（连击）= 5 功德
- 第6-20次：每次 1（基础）+ 5（连击）= 6 功德

总计：1 + 2 + 3 + 4 + 5 + (15 × 6) = 105 功德
```

## 📈 功德等级系统

根据累积的功德值，用户会获得不同的等级称号：

| 功德值范围 | 等级称号 | 说明 |
|-----------|---------|------|
| < 10      | 新手    | 刚开始使用 |
| 10-99     | 初学者  | 已经入门 |
| 100-499   | 初窥门径 | 开始理解 |
| 500-999   | 虔诚信徒 | 坚持使用 |
| 1000-4999 | 修行有成 | 长期用户 |
| 5000-9999 | 大德高僧 | 资深用户 |
| ≥ 10000   | 功德圆满 | 终极目标 |

## 🎯 达到各等级所需时间估算

假设用户每天敲击10次，连续打卡：

| 等级 | 所需功德 | 预计天数 | 说明 |
|-----|---------|---------|------|
| 初学者 | 10 | 1天 | 第一天就能达到 |
| 初窥门径 | 100 | 2-3天 | 包含里程碑奖励 |
| 虔诚信徒 | 500 | 7-10天 | 需要坚持一周以上 |
| 修行有成 | 1000 | 15-20天 | 需要坚持半个月以上 |
| 大德高僧 | 5000 | 60-80天 | 需要坚持2-3个月 |
| 功德圆满 | 10000 | 120-150天 | 需要坚持4-5个月 |

*注：实际时间会因每日敲击次数、连击情况等因素而有所不同*

## 💡 优化建议

### 最大化功德获取策略

1. **每日必做**：
   - 每天至少敲击一次（获得首次加成）
   - 保持连续天数（获得连续加成）

2. **连击技巧**：
   - 快速连续点击（3秒内）
   - 至少连击5次以上（达到最大加成）

3. **里程碑规划**：
   - 关注总敲击次数
   - 接近里程碑时集中敲击
   - 一次性获得大额奖励

4. **长期坚持**：
   - 连续打卡20天以上（达到最大连续加成）
   - 每天保持一定的敲击量
   - 功德值会持续稳定增长

### 避免的误区

1. **不要只追求连击**：
   - 连击加成有上限（+5）
   - 每日首次加成更重要（+5）
   - 连续天数加成更有价值（最多+10）

2. **不要忽视每日打卡**：
   - 中断连续天数会损失大量加成
   - 每日首次加成很容易获得
   - 长期坚持比短期爆发更有价值

3. **不要过度刷分**：
   - 各种加成都有上限
   - 适度敲击即可
   - 重点是保持连续性

## 🔧 技术实现

功德值计算的核心代码位于：
- `src/shared/utils/merit-calculator.ts`

主要函数：
- `calculateMeritGain()` - 计算单次敲击获得的功德
- `calculateComboBonus()` - 计算连击加成
- `calculateStreakBonus()` - 计算连续天数加成
- `checkMilestone()` - 检查里程碑奖励

## 📊 数据统计

功德值相关的数据存储：
- `merit` - 当前总功德值
- `combo` - 当前连击数
- `consecutiveDays` - 连续天数
- `totalKnocks` - 总敲击次数
- `lastKnockTime` - 上次敲击时间

## 🔮 未来计划

1. **功德值可视化**：
   - 功德增长曲线图
   - 各项加成占比饼图
   - 每日功德获取柱状图

2. **功德值用途**：
   - 解锁成就
   - 兑换主题
   - 排行榜展示

3. **社交功能**：
   - 功德值排行榜
   - 好友功德对比
   - 功德值赠送

---

**功德值系统让每次敲击都有意义，让坚持变得有价值！** 🙏
