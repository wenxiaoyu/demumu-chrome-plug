# M5 死亡通知系统 - 开发进度

## 已完成功能（迭代 1.15 + 1.16）

### ✅ 迭代 1.15：紧急联系人管理

### ✅ 数据模型和服务（任务 1.15.1 - 1.15.3）
- ✅ 创建联系人数据模型（EmergencyContact, ContactsData）
  - **简化设计**：取消 ContactGroup 枚举，直接使用 relationship 字符串分组
- ✅ 创建死亡检测配置模型（DeathDetectionConfig, DeathStatus）
- ✅ 创建邮件相关模型（EmailTemplate, EmailRecord）
- ✅ 实现联系人服务（ContactService）
  - 添加联系人（带邮箱验证、优先级验证）
  - 更新联系人
  - 删除联系人
  - 获取所有联系人
  - 按关系获取联系人（getContactsByRelationship）
  - 按优先级排序获取联系人
- ✅ 添加存储常量（STORAGE_KEYS, DEFAULT_CONTACTS_DATA, COMMON_RELATIONSHIPS等）

### ✅ UI 组件（任务 1.15.4 - 1.15.6）
- ✅ 创建联系人管理页面（ContactsPage）
  - **按关系自动分组**：根据 relationship 字段动态分组
  - 分组按中文拼音排序
  - 添加联系人按钮
  - 空状态提示
- ✅ 创建联系人表单组件（ContactForm）
  - 模态对话框形式
  - 表单验证（姓名、邮箱格式、关系必填）
  - **关系输入**：支持自定义输入 + 常用选项建议（家人、朋友、同事、其他）
  - 优先级滑块（1-5星）
  - 提示文字："输入关系后会自动分组显示"
  - 支持添加和编辑模式
- ✅ 创建联系人卡片组件（ContactCard）
  - 显示联系人信息（姓名、邮箱）
  - 优先级星级显示
  - 编辑和删除按钮
  - 删除确认对话框

### ✅ 页面集成（任务 1.15.7 - 1.15.9）
- ✅ Popup 页面底部添加设置入口（⚙️图标）
  - 点击打开 Options 页面
  - 悬停旋转动画效果
- ✅ Options 页面添加标签导航
  - 统计标签（现有功能）
  - 紧急联系人标签（新增）
  - 设置标签（占位符）
  - 支持 URL 参数指定默认标签（?tab=contacts）
- ✅ 创建联系人 Hook（useContacts）
  - 加载联系人数据
  - 添加、更新、删除操作
  - 按分组过滤
  - 按优先级排序
  - 错误处理

### ✅ 后台服务集成
- ✅ 在 background/index.ts 添加消息处理
  - GET_CONTACTS - 获取所有联系人
  - ADD_CONTACT - 添加联系人
  - UPDATE_CONTACT - 更新联系人
  - DELETE_CONTACT - 删除联系人

## 如何测试

### 1. 加载插件
```bash
# 构建项目（已完成）
npm run build

# 在 Chrome 中加载
1. 打开 chrome://extensions/
2. 开启"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择 dist 目录
```

### 2. 测试联系人管理（迭代 1.15）

#### 测试入口
1. 点击浏览器工具栏的插件图标
2. 在 Popup 页面底部找到 ⚙️ 设置图标
3. 点击设置图标，会打开 Options 页面
4. 点击"紧急联系人"标签

#### 测试添加联系人
1. 点击"+ 添加联系人"按钮
2. 填写表单：
   - 姓名：张三
   - 邮箱：zhang@example.com
   - 关系：父亲（可以输入或从建议中选择）
   - 优先级：5星（拖动滑块）
3. 点击"添加"按钮
4. 验证联系人出现在"父亲"分组下

#### 测试自定义关系分组
1. 添加多个联系人，使用不同的关系：
   - 张三 - 父亲
   - 李四 - 母亲
   - 王五 - 好友
   - 赵六 - 同事
2. 验证每个关系自动创建分组
3. 验证分组按中文拼音排序

#### 测试关系必填验证
1. 点击"+ 添加联系人"
2. 只填写姓名和邮箱，不填关系
3. 点击"添加"
4. 应该显示错误提示："请输入或选择关系"

#### 测试邮箱验证
1. 点击"+ 添加联系人"
2. 输入无效邮箱（如 "invalid-email"）
3. 点击"添加"
4. 应该显示错误提示："邮箱格式不正确"

#### 测试重复邮箱
1. 添加一个联系人（如 test@example.com）
2. 再次添加相同邮箱的联系人
3. 应该显示错误："Email already exists"

#### 测试编辑联系人
1. 在联系人卡片上点击"编辑"按钮
2. 修改信息（如改名字、调整优先级）
3. 点击"保存"
4. 验证信息已更新

#### 测试删除联系人
1. 在联系人卡片上点击"删除"按钮
2. 会弹出确认对话框
3. 点击"删除"确认
4. 验证联系人已从列表中移除

#### 测试分组显示
1. 添加不同关系的联系人：
   - 父亲：1个
   - 母亲：1个
   - 好友：2个
   - 同事：1个
2. 验证联系人按关系正确分组
3. 每个分组标题显示关系名称和数量
4. 验证分组按中文拼音排序（父亲、好友、母亲、同事）

#### 测试优先级显示
1. 添加不同优先级的联系人
2. 验证星级正确显示（1-5星）
3. 优先级越高，星星越多

### 3. 测试数据持久化
1. 添加几个联系人
2. 关闭 Options 页面
3. 重新打开 Options 页面
4. 验证联系人数据仍然存在

### 4. 测试响应式布局
1. 调整浏览器窗口大小
2. 验证布局在不同尺寸下正常显示
3. 移动端视图测试（Chrome DevTools 设备模拟）

### 5. 测试空状态
1. 删除所有联系人
2. 验证显示空状态提示：
   - 👥 图标
   - "还没有添加紧急联系人"
   - "点击上方按钮添加您的第一个联系人"

### ✅ 迭代 1.16：死亡检测算法

#### 死亡检测服务（任务 1.16.1 - 1.16.3）
- ✅ 创建死亡检测服务（DeathDetectionService）
  - 获取和更新配置
  - 计算未活跃天数
  - 判断是否"死亡"（基于 HP 和未活跃天数）
  - 检查死亡状态
  - 标记通知已发送
  - 重置状态

#### 定时检测机制（任务 1.16.4 - 1.16.5）
- ✅ 实现定时检测机制
  - 使用 Chrome Alarms API 创建定时任务
  - 根据配置的检查间隔自动检测
  - 检测到死亡状态时显示浏览器通知
  - 支持手动触发检测
- ✅ 死亡状态存储
  - 保存最新检测结果
  - 记录死亡原因、未活跃天数、最后活跃时间
  - 记录通知发送状态

#### 设置界面（任务 1.16.6 - 1.16.7）
- ✅ 创建死亡检测设置页面（SettingsPage）
  - 启用/禁用死亡检测开关
  - 未活跃天数阈值滑块（1-30天）
  - HP 阈值滑块（0-100）
  - 检查间隔选择（30分钟 - 24小时）
  - 当前状态显示卡片
  - 立即检测按钮
  - 使用说明
- ✅ 集成到 Options 页面
  - "设置"标签完整实现
  - 实时保存配置
  - 配置更新后自动重建定时任务

## 下一步开发

### ✅ 迭代 1.17：邮件发送系统（已完成 1.17.1 - 1.17.8）

#### 邮件模板和服务（任务 1.17.1 - 1.17.6）
- ✅ 创建邮件模板数据模型（EmailTemplate, EmailTemplateVariables）
- ✅ 设计默认邮件模板
  - HTML 和纯文本两种格式
  - 温和、关怀的语气
  - 包含用户状态、建议行动、免责声明
- ✅ 实现模板渲染引擎
  - 变量替换功能
  - HTML 转义
  - 模板验证
- ✅ 创建邮件发送服务（EmailService）
  - prepareEmail() - 准备邮件内容
  - generateMailtoLink() - 生成 mailto 链接
  - sendEmail() - 发送邮件（使用 mailto 协议）
  - sendToContacts() - 按优先级发送给联系人
  - 邮件发送记录管理
- ✅ 集成邮件发送到死亡检测服务
  - triggerEmailSend() - 触发邮件发送
  - prepareEmailVariables() - 准备模板变量
  - markEmailSent() - 标记邮件已发送
- ✅ 在 background/index.ts 添加消息处理
  - TRIGGER_EMAIL_SEND - 触发邮件发送

#### 邮件预览和测试（任务 1.17.7 - 1.17.8）
- ✅ 创建邮件预览组件（EmailPreview）
  - HTML 和纯文本视图切换
  - 实时渲染邮件内容
  - 发送测试邮件按钮
- ✅ 集成邮件预览到设置页面
  - 显示当前用户数据的邮件预览
  - 支持手动触发测试邮件
  - 使用 mailto 协议打开邮件客户端

#### 待完成任务（1.17.9 - 1.17.12）
- [ ] 实现死亡通知提醒（用户确认机制）
- [ ] 创建死亡状态指示器
- [ ] 实现数据加密（可选）
- [ ] 添加隐私说明

### 迭代 1.18：用户确认和隐私保护（待开发）
- [ ] 死亡通知确认对话框
- [ ] Popup 页面死亡状态提示
- [ ] 隐私政策说明
- [ ] 数据导出和删除功能

## 技术细节

### 数据存储
- 使用 Chrome Storage API
- 存储键：`emergencyContacts`
- 数据格式：
```typescript
{
  contacts: EmergencyContact[],
  version: 1
}
```

### 消息通信
- Popup/Options → Background：chrome.runtime.sendMessage
- 消息类型：
  - GET_CONTACTS
  - ADD_CONTACT
  - UPDATE_CONTACT
  - DELETE_CONTACT

### 验证规则
- 邮箱格式：`/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
- 优先级范围：1-5
- 最大联系人数：20
- 姓名、邮箱、关系为必填项
- 关系字段用于自动分组

## 设计改进

### 简化分组逻辑
**原设计**：
- 有 ContactGroup 枚举（Family, Friend, Colleague, Other）
- EmergencyContact 同时有 relationship 和 group 字段
- 用户需要选择分组

**新设计**：
- 取消 ContactGroup 枚举
- EmergencyContact 只有 relationship 字段
- 用户输入关系（如：父亲、母亲、好友、同事等）
- 系统根据 relationship 自动分组
- 提供常用关系建议（家人、朋友、同事、其他）

**优势**：
- ✅ 更灵活：用户可以自定义任何关系
- ✅ 更简单：减少一个字段，减少用户选择
- ✅ 更直观：关系即分组，概念统一
- ✅ 更自然：符合中文表达习惯

## 已知问题
- ~~通知图标错误（SVG 格式不支持）~~ ✅ 已修复
  - 修复方法：移除 iconUrl 参数，使用扩展默认图标
  - 影响文件：notification-service.ts, background/index.ts
- ~~邮件发送失败时没有友好提示~~ ✅ 已修复
  - 修复方法：添加联系人检查和友好错误提示
  - 影响文件：SettingsPage.tsx, EmailPreview.tsx, email-service.ts
- ~~设置页面布局不一致~~ ✅ 已修复
  - 修复方法：统一三个标签页的最大宽度为 1000px
  - 影响文件：SettingsPage.css, ContactsPage.css
- ~~Service Worker 中使用 window.open() 报错~~ ✅ 已修复
  - 修复方法：使用 chrome.tabs.create() 替代 window.open()
  - 影响文件：email-service.ts

## 性能优化
- 使用 React.memo 优化组件渲染（待实现）
- 使用 useMemo 缓存计算结果（待实现）

## 样式特点
- 禅意风格设计
- 柔和的配色（#f8f5ed 背景）
- 圆角卡片设计
- 悬停效果和过渡动画
- 响应式布局

## 构建信息
- 构建命令：`npm run build`
- 构建时间：~2秒
- 输出目录：`dist/`
- 构建状态：✅ 成功


---

## 测试死亡检测功能（迭代 1.16）

### 测试入口
1. 在 Options 页面点击"设置"标签
2. 进入死亡检测设置页面

### 测试启用/禁用检测
1. 点击"启用死亡检测"开关
2. 验证开关状态切换
3. 启用后显示配置选项
4. 禁用后隐藏配置选项

### 测试配置调整
1. 启用死亡检测
2. 调整"未活跃天数阈值"滑块（1-30天）
3. 调整"HP 阈值"滑块（0-100）
4. 选择"检查间隔"（30分钟 - 24小时）

### 测试立即检测
1. 点击"立即检测"按钮
2. 验证按钮显示"检测中..."
3. 检测完成后显示当前状态卡片

### 测试死亡状态触发

**方法1：调整 HP 阈值**
1. 查看当前 HP 值（在 Popup 页面）
2. 在设置中将 HP 阈值设置为高于当前 HP
3. 点击"立即检测"
4. 验证显示"已触发死亡检测"

**方法2：调整未活跃天数阈值**
1. 在设置中将未活跃天数阈值设置为 1 天
2. 确保今天没有敲击木鱼
3. 点击"立即检测"
4. 验证显示"已触发死亡检测"

### 测试定时检测
1. 启用死亡检测，设置检查间隔为 30 分钟
2. 等待 30 分钟
3. 检查 Service Worker 日志（右键扩展图标 → "检查 Service Worker"）
4. 应该看到 "[Background] Death check alarm triggered"
5. 如果触发死亡检测，会收到浏览器通知

---

## 测试邮件发送功能（迭代 1.17）

### 前提条件
1. 确保已添加至少一个紧急联系人
2. 在"紧急联系人"标签页添加联系人

### 测试步骤

#### 1. 测试邮件预览
1. 打开 Options 页面 → 设置标签
2. 滚动到底部查看"邮件预览"区域
3. 切换 HTML 和纯文本视图
4. 查看渲染后的邮件内容

#### 2. 测试无联系人提示
1. 如果还没有添加联系人
2. 邮件预览区域会显示警告：⚠️ 还没有添加紧急联系人
3. "发送测试邮件"按钮会被禁用
4. 鼠标悬停按钮会显示提示："请先添加紧急联系人"

#### 3. 测试有联系人提示
1. 添加至少一个紧急联系人
2. 邮件预览区域会显示：✅ 已添加 X 个紧急联系人
3. "发送测试邮件"按钮变为可用状态

#### 4. 测试邮件发送
1. 点击"发送测试邮件"按钮
2. 会打开默认邮件客户端（如 Outlook、Thunderbird、Mail 等）
3. 邮件内容已自动填充：
   - 收件人：您的紧急联系人（按优先级排序，最多 5 个）
   - 主题：紧急通知：用户 可能需要关注
   - 正文：包含您的活跃状态、HP、功德值等信息
4. 在邮件客户端中确认发送

#### 5. 测试错误提示
1. 如果没有添加联系人就点击发送
2. 会显示友好提示：❌ 发送失败：还没有添加紧急联系人
3. 提示中会引导用户到"紧急联系人"标签页添加联系人

### 注意事项
- Phase 1 使用 mailto 协议，需要用户手动确认发送
- 需要系统安装邮件客户端（如 Outlook、Thunderbird、Mail 等）
- 如果没有邮件客户端，浏览器可能会提示设置默认邮件应用
- 邮件内容使用纯文本格式（mailto 协议限制）

---

## 功能特性总结

### 迭代 1.15 特性
- ✅ 灵活的关系分组（自定义关系）
- ✅ 5级优先级系统
- ✅ 邮箱格式验证
- ✅ 最多20个联系人
- ✅ 删除确认对话框
- ✅ 空状态提示
- ✅ 响应式布局

### 迭代 1.16 特性
- ✅ 可配置的死亡检测规则
- ✅ 双重检测条件（HP + 未活跃天数）
- ✅ 灵活的检查间隔（30分钟 - 24小时）
- ✅ 实时状态显示
- ✅ 手动触发检测
- ✅ 浏览器通知
- ✅ 定时自动检测

---

## 构建信息
- 构建命令：`npm run build`
- 构建时间：~2秒
- 输出目录：`dist/`
- 构建状态：✅ 成功
- 最新构建：迭代 1.16 完成
