# 阶段 1：MVP 本地版 - 迭代计划

## 迭代策略

采用**垂直切片**方式，每个迭代都实现一个完整的、可演示的功能切片，从数据层到 UI 层。

每个迭代：
- ✅ 可独立开发和测试
- ✅ 可独立演示和验证
- ✅ 增量交付价值
- ✅ 1-2 天完成

---

## 迭代 1.1：最小可用木鱼（0.5 天）

### 目标
实现最基础的敲木鱼功能，用户可以点击并看到反馈。

### 范围
- ✅ 基础数据模型
- ✅ 简单的木鱼按钮
- ✅ 点击计数
- ✅ 本地存储

### 任务
1. **数据层**
   - [ ] 创建 `UserData` 类型（简化版：只包含 totalKnocks）
   - [ ] 实现 Storage 基础方法（get/set）
   - [ ] 初始化用户数据

2. **UI 层**
   - [ ] 创建 Popup 基础页面
   - [ ] 创建简单的木鱼按钮（文字或简单图形）
   - [ ] 显示总敲击次数

3. **逻辑层**
   - [ ] 实现点击事件处理
   - [ ] 敲击次数 +1
   - [ ] 保存到本地存储

### 验收标准
- [ ] 点击木鱼，总次数增加
- [ ] 刷新页面，数据保持
- [ ] 无 Console 错误

### 交付物
- 可点击的木鱼按钮
- 显示总敲击次数

---

## 迭代 1.2：今日敲击统计（0.5 天）

### 目标
区分今日敲击和总敲击，实现跨天重置。

### 范围
- ✅ 今日敲击计数
- ✅ 跨天检测
- ✅ 自动重置

### 任务
1. **数据层**
   - [ ] 扩展 `UserData`：添加 `todayKnocks`, `lastKnockTime`
   - [ ] 实现日期工具函数（`isSameDay`, `getStartOfDay`）

2. **逻辑层**
   - [ ] 实现跨天检测逻辑
   - [ ] 敲击时检查是否跨天
   - [ ] 跨天时重置 `todayKnocks = 0`

3. **UI 层**
   - [ ] 显示今日敲击次数
   - [ ] 显示总敲击次数

### 验收标准
- [ ] 今日敲击次数正确累加
- [ ] 跨天后今日次数重置为 0
- [ ] 总次数持续累加

### 交付物
- 区分今日和总敲击的显示

---

## 迭代 1.3：功德值系统（0.5 天）

### 目标
实现功德值累积，每次敲击 +1 功德。

### 范围
- ✅ 功德值计算
- ✅ 功德值显示
- ✅ 功德值持久化

### 任务
1. **数据层**
   - [ ] 扩展 `UserData`：添加 `merit`
   - [ ] 定义 `MERIT_CONFIG` 常量

2. **逻辑层**
   - [ ] 每次敲击 merit +1
   - [ ] 保存功德值

3. **UI 层**
   - [ ] 显示当前功德值
   - [ ] 美化功德值展示（图标 + 数字）

### 验收标准
- [ ] 每次敲击功德值 +1
- [ ] 功德值永久保存
- [ ] 功德值显示清晰

### 交付物
- 功德值显示和累积功能

---

## 迭代 1.4：生命值系统（1 天）

### 目标
实现 HP 系统，每日首次敲击 +10 HP，未敲击 -10 HP/天。

### 范围
- ✅ HP 初始化
- ✅ HP 计算逻辑
- ✅ HP 进度条显示
- ✅ HP 颜色变化

### 任务
1. **数据层**
   - [ ] 扩展 `UserData`：添加 `hp`, `status`
   - [ ] 定义 `HP_CONFIG` 常量
   - [ ] 定义 `HP_THRESHOLDS` 常量

2. **逻辑层**
   - [ ] 实现 HP 计算工具（`calculateCurrentHP`）
   - [ ] 实现 HP 奖励逻辑（首次敲击 +10）
   - [ ] 实现 HP 惩罚逻辑（未敲击 -10/天）
   - [ ] 实现 HP 状态判断（healthy/warning/critical）

3. **UI 层**
   - [ ] 创建 HPBar 组件
   - [ ] 实现进度条
   - [ ] 根据 HP 显示不同颜色
   - [ ] 显示 HP 数值（80/100）

### 验收标准
- [ ] 初始 HP = 100
- [ ] 今日首次敲击 HP +10
- [ ] 今日再次敲击 HP 不变
- [ ] 跨天未敲击 HP -10
- [ ] HP 颜色正确变化（绿/黄/红）
- [ ] HP 不超过 100，不低于 0

### 交付物
- HP 进度条组件
- HP 计算逻辑

---

## 迭代 1.5：连续活跃天数（0.5 天）

### 目标
计算连续活跃天数，断活后归零。

### 范围
- ✅ 连续天数计算
- ✅ 断活检测
- ✅ 连续天数显示

### 任务
1. **数据层**
   - [ ] 扩展 `UserData`：添加 `consecutiveDays`

2. **逻辑层**
   - [ ] 实现连续天数计算（`calculateConsecutiveDays`）
   - [ ] 今日首次敲击时更新连续天数
   - [ ] 断活时重置为 1

3. **UI 层**
   - [ ] 显示连续活跃天数
   - [ ] 添加图标和文案

### 验收标准
- [ ] 连续敲击天数正确累加
- [ ] 断活后重置为 1
- [ ] 显示清晰

### 交付物
- 连续活跃天数显示

---

## 迭代 1.6：状态检测和通知（1 天）

### 目标
实现后台状态检测，HP = 0 时显示死亡通知。

### 范围
- ✅ Background Service Worker
- ✅ 定时检查
- ✅ 死亡通知
- ✅ HP 警告通知

### 任务
1. **Background 层**
   - [ ] 创建 `background/index.ts`
   - [ ] 实现 StatusChecker 服务
   - [ ] 实现定时任务（chrome.alarms）
   - [ ] 监听浏览器启动事件

2. **逻辑层**
   - [ ] 实现状态检查逻辑
   - [ ] 检测 HP 是否归零
   - [ ] 检测 HP 是否低于 30

3. **通知层**
   - [ ] 创建 NotificationService
   - [ ] 实现死亡通知（HP = 0）
   - [ ] 实现警告通知（HP < 30）
   - [ ] 设计通知文案（禅意风格）

### 验收标准
- [ ] 每小时自动检查状态
- [ ] HP = 0 时显示"往生"通知
- [ ] HP < 30 时显示警告通知
- [ ] 浏览器启动时检查状态

### 交付物
- 后台状态检测
- 通知系统

---

## 迭代 1.7：敲击记录历史（0.5 天）

### 目标
保存每次敲击的详细记录。

### 范围
- ✅ 敲击记录存储
- ✅ 历史记录查询

### 任务
1. **数据层**
   - [ ] 定义 `KnockRecord` 类型
   - [ ] 实现记录 ID 生成
   - [ ] 实现记录存储（数组）

2. **逻辑层**
   - [ ] 每次敲击保存记录
   - [ ] 实现历史查询（最近 N 天）
   - [ ] 限制记录数量（最多保存 365 天）

### 验收标准
- [ ] 每次敲击都有记录
- [ ] 记录包含时间戳、功德值、HP 等
- [ ] 可查询历史记录

### 交付物
- 敲击记录存储和查询

---

## 迭代 1.8：每日统计（0.5 天）

### 目标
按天统计敲击数据，用于日历和图表。

### 范围
- ✅ 每日统计数据
- ✅ 统计数据聚合

### 任务
1. **数据层**
   - [ ] 定义 `DailyStats` 类型
   - [ ] 实现每日统计存储

2. **逻辑层**
   - [ ] 每次敲击更新当日统计
   - [ ] 跨天时创建新的统计记录
   - [ ] 实现统计查询（最近 N 天）

### 验收标准
- [ ] 每天有独立的统计记录
- [ ] 统计包含敲击次数、功德值、HP
- [ ] 可查询历史统计

### 交付物
- 每日统计数据

---

## 迭代 1.9：活跃日历（1 天）

### 目标
实现月历视图，显示每日敲击情况。

### 范围
- ✅ Options 页面基础
- ✅ 月历组件
- ✅ 热力图显示

### 任务
1. **UI 层**
   - [ ] 创建 Options 页面
   - [ ] 创建 Calendar 组件
   - [ ] 实现月历布局（7x5 网格）
   - [ ] 实现月份切换

2. **逻辑层**
   - [ ] 获取当月每日统计
   - [ ] 计算颜色深浅（基于敲击次数）
   - [ ] 处理跨月数据

3. **样式层**
   - [ ] 实现热力图颜色（4 个等级）
   - [ ] 添加图例说明
   - [ ] 响应式设计

### 验收标准
- [ ] 显示当月日历
- [ ] 颜色深浅表示敲击次数
- [ ] 可切换月份
- [ ] 有图例说明

### 交付物
- 活跃日历组件

---

## 迭代 1.10：数据总览（0.5 天）

### 目标
显示关键统计数据。

### 范围
- ✅ 数据卡片
- ✅ 关键指标

### 任务
1. **UI 层**
   - [ ] 创建 DataOverview 组件
   - [ ] 设计数据卡片布局

2. **逻辑层**
   - [ ] 计算总功德值
   - [ ] 计算总敲击次数
   - [ ] 计算最长连续活跃
   - [ ] 计算平均每日敲击
   - [ ] 计算存活天数

### 验收标准
- [ ] 显示所有关键指标
- [ ] 数据准确
- [ ] 布局美观

### 交付物
- 数据总览组件

---

## 迭代 1.11：统计图表（1 天）

### 目标
实现数据可视化图表。

### 范围
- ✅ 连续活跃趋势图
- ✅ HP 变化曲线
- ✅ 每日敲击趋势
- ✅ 功德值累计曲线

### 任务
1. **UI 层**
   - [ ] 创建 StatsChart 组件
   - [ ] 选择图表库（或使用 SVG/Canvas）

2. **逻辑层**
   - [ ] 准备图表数据
   - [ ] 实现数据转换

3. **图表实现**
   - [ ] 连续活跃天数折线图
   - [ ] HP 变化曲线图
   - [ ] 每日敲击柱状图
   - [ ] 功德值累计曲线

### 验收标准
- [ ] 图表显示正确
- [ ] 数据准确
- [ ] 交互流畅

### 交付物
- 统计图表组件

---

## 迭代 1.12：样式和动画（1 天）

### 目标
优化 UI 样式，添加基础动画。

### 范围
- ✅ 全局样式
- ✅ 禅意风格
- ✅ 基础动画

### 任务
1. **样式系统**
   - [ ] 定义 CSS 变量（颜色、字体、间距）
   - [ ] 设计禅意配色方案
   - [ ] 统一组件样式

2. **动画效果**
   - [ ] 木鱼点击动画（简单缩放）
   - [ ] HP 变化动画（平滑过渡）
   - [ ] 页面过渡动画

3. **响应式**
   - [ ] 适配不同屏幕尺寸
   - [ ] 确保 Popup 和 Options 都响应式

### 验收标准
- [ ] 视觉风格统一
- [ ] 动画流畅自然
- [ ] 响应式布局正常

### 交付物
- 完整的样式系统
- 基础动画效果

---

## 迭代 1.13：测试和优化（1 天）

### 目标
全面测试，修复 bug，优化性能。

### 范围
- ✅ 功能测试
- ✅ 边界测试
- ✅ 性能优化

### 任务
1. **功能测试**
   - [ ] 测试敲木鱼流程
   - [ ] 测试跨天逻辑
   - [ ] 测试 HP 计算
   - [ ] 测试连续天数
   - [ ] 测试通知

2. **边界测试**
   - [ ] 首次使用
   - [ ] 大量敲击（1000+ 次）
   - [ ] 长时间未使用（30+ 天）
   - [ ] HP 归零
   - [ ] 数据清除

3. **性能优化**
   - [ ] 优化存储读写
   - [ ] 优化渲染性能
   - [ ] 检查内存泄漏

4. **代码质量**
   - [ ] TypeScript 类型检查
   - [ ] ESLint 检查
   - [ ] 代码格式化
   - [ ] 添加注释

### 验收标准
- [ ] 所有功能正常
- [ ] 无明显 bug
- [ ] 性能良好
- [ ] 代码质量达标

### 交付物
- 稳定的 MVP 版本

---

## 迭代 1.14：文档和发布（0.5 天）

### 目标
完善文档，准备发布。

### 范围
- ✅ 使用文档
- ✅ 截图
- ✅ 发布准备

### 任务
1. **文档**
   - [ ] 更新 README
   - [ ] 添加使用说明
   - [ ] 添加截图

2. **发布**
   - [ ] 构建生产版本
   - [ ] 测试打包
   - [ ] 创建 release notes
   - [ ] 创建 Git 标签 v0.2.0

### 验收标准
- [ ] 文档完整
- [ ] 截图清晰
- [ ] 可以成功构建

### 交付物
- 完整的文档
- 可发布的版本

---

## 迭代总览

| 迭代 | 名称 | 时间 | 优先级 | 依赖 |
|------|------|------|--------|------|
| 1.1 | 最小可用木鱼 | 0.5天 | P0 | 无 |
| 1.2 | 今日敲击统计 | 0.5天 | P0 | 1.1 |
| 1.3 | 功德值系统 | 0.5天 | P0 | 1.2 |
| 1.4 | 生命值系统 | 1天 | P0 | 1.3 |
| 1.5 | 连续活跃天数 | 0.5天 | P0 | 1.4 |
| 1.6 | 状态检测和通知 | 1天 | P0 | 1.5 |
| 1.7 | 敲击记录历史 | 0.5天 | P1 | 1.6 |
| 1.8 | 每日统计 | 0.5天 | P1 | 1.7 |
| 1.9 | 活跃日历 | 1天 | P1 | 1.8 |
| 1.10 | 数据总览 | 0.5天 | P1 | 1.8 |
| 1.11 | 统计图表 | 1天 | P2 | 1.8 |
| 1.12 | 样式和动画 | 1天 | P1 | 1.11 |
| 1.13 | 测试和优化 | 1天 | P0 | 1.12 |
| 1.14 | 文档和发布 | 0.5天 | P0 | 1.13 |

**总计：10 天**

## 优先级说明

- **P0（必须）**：核心功能，必须完成
- **P1（重要）**：重要功能，应该完成
- **P2（可选）**：增强功能，可以延后

## MVP 最小集合

如果时间紧张，可以只完成 P0 迭代：
- 1.1 - 1.6：核心敲木鱼功能（4 天）
- 1.13：测试和优化（1 天）
- 1.14：文档和发布（0.5 天）

**MVP 最小时间：5.5 天**

## 完整版本

完成所有迭代：**10 天**

## 建议执行顺序

**第 1 周（5 天）：**
- Day 1：迭代 1.1 + 1.2 + 1.3
- Day 2：迭代 1.4
- Day 3：迭代 1.5 + 1.6
- Day 4：迭代 1.7 + 1.8
- Day 5：迭代 1.9 + 1.10

**第 2 周（5 天）：**
- Day 1：迭代 1.11
- Day 2：迭代 1.12
- Day 3-4：迭代 1.13
- Day 5：迭代 1.14

## 里程碑

- **M1（Day 3）**：核心功能可用（敲木鱼 + HP + 通知）
- **M2（Day 5）**：数据统计完成（历史 + 日历）
- **M3（Day 7）**：可视化完成（图表 + 样式）
- **M4（Day 10）**：MVP 发布

## 风险和应对

### 风险 1：图表实现复杂
- **应对**：使用简单的 SVG 或现成图表库
- **备选**：降级为简单的数据列表

### 风险 2：动画性能问题
- **应对**：使用 CSS 动画，避免 JS 动画
- **备选**：简化或移除动画

### 风险 3：时间不足
- **应对**：优先完成 P0 迭代
- **备选**：P1/P2 迭代延后到阶段 2

## 下一步

1. **确认迭代计划**：请确认这个拆分是否合理
2. **选择起点**：从迭代 1.1 开始
3. **开始开发**：按照迭代顺序逐个完成

**准备好开始了吗？我们可以从迭代 1.1 开始！**
