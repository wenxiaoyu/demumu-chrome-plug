# M7ï¼šç”¨æˆ·è®¤è¯ä¸äº‘ç«¯åŒæ­¥

## ç›®æ ‡

å®ç° Google è´¦å·ç™»å½•å’Œäº‘ç«¯æ•°æ®åŒæ­¥åŠŸèƒ½ï¼Œä¸ºé‚®ä»¶é€šçŸ¥æä¾›å¿…è¦çš„ç”¨æˆ·è®¤è¯åŸºç¡€ã€‚æœªç™»å½•ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç™»å½•åæ•°æ®åŒæ­¥åˆ°äº‘ç«¯ã€‚

**é‡Œç¨‹ç¢‘ä»·å€¼ï¼š** 
- ä¸ºé‚®ä»¶å‘é€åŠŸèƒ½æä¾›ç”¨æˆ·èº«ä»½éªŒè¯
- å®ç°æ•°æ®äº‘ç«¯å¤‡ä»½å’Œå¤šè®¾å¤‡åŒæ­¥
- ä¸ºåç»­ç¤¾äº¤åŠŸèƒ½æ‰“ä¸‹åŸºç¡€

## æ—¶é—´ä¼°ç®—

**è®¡åˆ’ï¼š5 å¤©**

- Firebase é¡¹ç›®è®¾ç½®å’Œé…ç½®ï¼ˆ0.5 å¤©ï¼‰
- Google ç™»å½•é›†æˆï¼ˆ1 å¤©ï¼‰
- æ•°æ®åŒæ­¥æœåŠ¡ï¼ˆ1 å¤©ï¼‰
- UI é›†æˆå’Œç™»å½•æç¤ºï¼ˆ0.3 å¤©ï¼‰
- é‚®ä»¶å‘é€é›†æˆï¼ˆ0.2 å¤©ï¼‰
- **äº‘ç«¯æ­»äº¡æ£€æµ‹å’Œé‚®ä»¶é€šçŸ¥ï¼ˆ2 å¤©ï¼‰**
  - é‚®ä»¶æœåŠ¡é›†æˆï¼ˆSendGrid/Mailgunï¼‰ï¼ˆ0.5 å¤©ï¼‰
  - Cloud Functions å¼€å‘ï¼ˆ1 å¤©ï¼‰
  - æµ‹è¯•å’Œè°ƒè¯•ï¼ˆ0.5 å¤©ï¼‰
- æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1 å¤©ï¼‰

## èŒƒå›´

### åŒ…å«
- âœ… Firebase é¡¹ç›®è®¾ç½®
- âœ… Google è´¦å·ç™»å½•ï¼ˆFirebase Authenticationï¼‰
- âœ… ç”¨æˆ·æ•°æ®äº‘ç«¯å­˜å‚¨ï¼ˆFirestoreï¼‰
- âœ… æœ¬åœ°æ•°æ®è¿ç§»åˆ°äº‘ç«¯
- âœ… æ•°æ®åŒå‘åŒæ­¥ï¼ˆæœ¬åœ° â†” äº‘ç«¯ï¼‰
- âœ… ç™»å½•çŠ¶æ€ç®¡ç†
- âœ… ç™»å½•æç¤ºå’Œå¼•å¯¼
- âœ… ç¦»çº¿æ¨¡å¼æ”¯æŒ

### ä¸åŒ…å«
- âŒ é‚®ç®±å¯†ç ç™»å½•ï¼ˆä»… Google ç™»å½•ï¼‰
- âŒ å¥½å‹ç³»ç»Ÿï¼ˆM8 æˆ–é˜¶æ®µ 3ï¼‰
- âŒ æ’è¡Œæ¦œï¼ˆM8 æˆ–é˜¶æ®µ 3ï¼‰
- âŒ ç¤¾äº¤åŠŸèƒ½ï¼ˆé˜¶æ®µ 3ï¼‰

### æ–°å¢åŠŸèƒ½ï¼ˆäº‘ç«¯æ­»äº¡æ£€æµ‹ï¼‰
- âœ… Firebase Cloud Functions å®šæ—¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
- âœ… è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ˜¯å¦"æ­»äº¡"ï¼ˆåŸºäº HP å’Œæœªæ´»è·ƒå¤©æ•°ï¼‰
- âœ… è‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥ç»™ç´§æ€¥è”ç³»äºº
- âœ… ä½¿ç”¨çœŸå®é‚®ä»¶æœåŠ¡ï¼ˆSendGrid/Mailgun/Gmail SMTPï¼‰
- âœ… é˜²æ­¢é‡å¤å‘é€ï¼ˆè®°å½•å‘é€çŠ¶æ€ï¼‰
- âœ… é‚®ä»¶å‘é€å†å²è®°å½•

## è¯¦ç»†è®¾è®¡

### 1. æŠ€æœ¯æ–¹æ¡ˆ

#### 1.1 æŠ€æœ¯æ ˆé€‰æ‹©

**Firebase + Firestoreï¼ˆæ¨èæ–¹æ¡ˆï¼‰**

**ä¼˜åŠ¿ï¼š**
- **é›¶åç«¯å¼€å‘**ï¼šä½¿ç”¨ Firebase SDK ç›´æ¥æ“ä½œï¼Œæ— éœ€ç¼–å†™åç«¯ä»£ç 
- **å®æ—¶åŒæ­¥**ï¼šFirestore æä¾›å®æ—¶æ•°æ®åŒæ­¥
- **å…è´¹é¢åº¦å……è¶³**ï¼š
  - Authentication: æ— é™ç”¨æˆ·
  - Firestore: 1GB å­˜å‚¨ + 50K è¯»å–/å¤© + 20K å†™å…¥/å¤©
  - å¯¹äº 1000 ç”¨æˆ·ä»¥å†…å®Œå…¨å…è´¹
- **å®‰å…¨è§„åˆ™**ï¼šé€šè¿‡ Firestore Security Rules æ§åˆ¶æ•°æ®è®¿é—®
- **å®˜æ–¹æ”¯æŒ**ï¼šGoogle å®˜æ–¹ç»´æŠ¤ï¼Œæ–‡æ¡£å®Œå–„

**æˆæœ¬ä¼°ç®—ï¼ˆæœˆï¼‰ï¼š**
- 0-1000 ç”¨æˆ·ï¼š$0ï¼ˆå…è´¹é¢åº¦å†…ï¼‰
- 1000-5000 ç”¨æˆ·ï¼š$5-20
- 5000+ ç”¨æˆ·ï¼šæŒ‰éœ€ä»˜è´¹


#### 1.2 Firebase é¡¹ç›®ç»“æ„

```
Firebase Project: alive-checker
â”œâ”€â”€ Authentication
â”‚   â””â”€â”€ Google Sign-In Provider
â”œâ”€â”€ Firestore Database
â”‚   â”œâ”€â”€ users/              # ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
â”‚   â”œâ”€â”€ userData/           # ç”¨æˆ·æ•°æ®ï¼ˆHPã€åŠŸå¾·å€¼ç­‰ï¼‰
â”‚   â”œâ”€â”€ knockRecords/       # æ•²å‡»è®°å½•
â”‚   â”œâ”€â”€ dailyStats/         # æ¯æ—¥ç»Ÿè®¡
â”‚   â””â”€â”€ emergencyContacts/  # ç´§æ€¥è”ç³»äºº
â””â”€â”€ Security Rules          # æ•°æ®è®¿é—®æ§åˆ¶
```

#### 1.3 æ•°æ®æ¨¡å‹è®¾è®¡

```typescript
// Firestore Collections

// users/{uid}
interface User {
  uid: string;
  email: string;
  displayName: string;
  photoURL?: string;
  createdAt: number;
  lastSyncAt: number;
}

// userData/{uid}
interface UserData {
  uid: string;
  totalKnocks: number;
  todayKnocks: number;
  lastKnockTime: number;
  merit: number;
  hp: number;
  consecutiveDays: number;
  status: 'alive' | 'dead';
  updatedAt: number;
}

// knockRecords/{uid}/records/{recordId}
interface KnockRecord {
  id: string;
  timestamp: number;
  merit: number;
  hp: number;
  consecutiveDays: number;
}

// dailyStats/{uid}/stats/{date}
interface DailyStats {
  date: string; // YYYY-MM-DD
  knocks: number;
  merit: number;
  hp: number;
}

// emergencyContacts/{uid}
interface EmergencyContactsData {
  uid: string;
  contacts: EmergencyContact[];
  version: number;
  updatedAt: number;
}
```

### 2. ç”¨æˆ·è®¤è¯æµç¨‹

#### 2.1 Google ç™»å½•æµç¨‹

```typescript
// ç™»å½•æµç¨‹
1. ç”¨æˆ·ç‚¹å‡»"ä½¿ç”¨ Google ç™»å½•"æŒ‰é’®
2. è°ƒç”¨ Firebase signInWithPopup(GoogleAuthProvider)
3. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆuid, email, displayName, photoURLï¼‰
4. æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ç™»å½•
5. å¦‚æœé¦–æ¬¡ç™»å½•ï¼š
   - åˆ›å»º users/{uid} æ–‡æ¡£
   - è¿ç§»æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
6. å¦‚æœå·²ç™»å½•è¿‡ï¼š
   - åŒæ­¥äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°
7. ä¿å­˜ç™»å½•çŠ¶æ€åˆ° Chrome Storage
8. æ˜¾ç¤ºç™»å½•æˆåŠŸæç¤º
```

#### 2.2 ç™»å½•çŠ¶æ€ç®¡ç†

```typescript
// src/shared/services/auth-service.ts
export class AuthService {
  private auth: Auth;
  private currentUser: User | null = null;

  async signInWithGoogle(): Promise<User> {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(this.auth, provider);
    this.currentUser = result.user;
    await this.saveAuthState();
    return result.user;
  }

  async signOut(): Promise<void> {
    await signOut(this.auth);
    this.currentUser = null;
    await this.clearAuthState();
  }

  async getCurrentUser(): Promise<User | null> {
    // ä» Chrome Storage æ¢å¤ç™»å½•çŠ¶æ€
    return this.currentUser;
  }

  isSignedIn(): boolean {
    return this.currentUser !== null;
  }
}
```


### 3. æ•°æ®åŒæ­¥ç­–ç•¥

#### 3.1 åŒæ­¥åŸåˆ™

**æœ¬åœ°ä¼˜å…ˆï¼ˆLocal-Firstï¼‰ï¼š**
- æ‰€æœ‰æ“ä½œå…ˆåœ¨æœ¬åœ°å®Œæˆï¼Œç«‹å³å“åº”
- åå°å¼‚æ­¥åŒæ­¥åˆ°äº‘ç«¯
- ç¦»çº¿æ—¶æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ä½¿ç”¨
- è”ç½‘åè‡ªåŠ¨åŒæ­¥

**å†²çªè§£å†³ï¼š**
- ä½¿ç”¨æ—¶é—´æˆ³ï¼ˆupdatedAtï¼‰åˆ¤æ–­æœ€æ–°æ•°æ®
- ä»¥æœ€æ–°æ—¶é—´æˆ³çš„æ•°æ®ä¸ºå‡†
- è®°å½•åŒæ­¥æ—¥å¿—ä¾¿äºè°ƒè¯•

#### 3.2 åŒæ­¥æ—¶æœº

```typescript
// è‡ªåŠ¨åŒæ­¥æ—¶æœº
1. ç”¨æˆ·ç™»å½•åç«‹å³åŒæ­¥
2. æ•²å‡»æœ¨é±¼ååŒæ­¥ï¼ˆé˜²æŠ– 5 ç§’ï¼‰
3. æ·»åŠ /ä¿®æ”¹ç´§æ€¥è”ç³»äººååŒæ­¥
4. æ¯ 30 åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
5. æµè§ˆå™¨ä»ç¦»çº¿æ¢å¤æ—¶åŒæ­¥
6. æ‰“å¼€ Popup/Options é¡µé¢æ—¶åŒæ­¥

// æ‰‹åŠ¨åŒæ­¥
- è®¾ç½®é¡µé¢æä¾›"ç«‹å³åŒæ­¥"æŒ‰é’®
- æ˜¾ç¤ºæœ€ååŒæ­¥æ—¶é—´
```

#### 3.3 åŒæ­¥æœåŠ¡å®ç°

```typescript
// src/shared/services/sync-service.ts
export class SyncService {
  private db: Firestore;
  private authService: AuthService;
  private syncQueue: SyncTask[] = [];
  private isSyncing = false;

  // åŒæ­¥ç”¨æˆ·æ•°æ®
  async syncUserData(): Promise<void> {
    const user = await this.authService.getCurrentUser();
    if (!user) return;

    const localData = await storage.getUserData();
    const cloudData = await this.getCloudUserData(user.uid);

    if (!cloudData || localData.updatedAt > cloudData.updatedAt) {
      // æœ¬åœ°æ•°æ®æ›´æ–°ï¼Œä¸Šä¼ åˆ°äº‘ç«¯
      await this.uploadUserData(user.uid, localData);
    } else if (cloudData.updatedAt > localData.updatedAt) {
      // äº‘ç«¯æ•°æ®æ›´æ–°ï¼Œä¸‹è½½åˆ°æœ¬åœ°
      await storage.setUserData(cloudData);
    }
  }

  // åŒæ­¥ç´§æ€¥è”ç³»äºº
  async syncEmergencyContacts(): Promise<void> {
    const user = await this.authService.getCurrentUser();
    if (!user) return;

    const localContacts = await storage.getEmergencyContacts();
    const cloudContacts = await this.getCloudContacts(user.uid);

    if (!cloudContacts || localContacts.updatedAt > cloudContacts.updatedAt) {
      await this.uploadContacts(user.uid, localContacts);
    } else if (cloudContacts.updatedAt > localContacts.updatedAt) {
      await storage.setEmergencyContacts(cloudContacts);
    }
  }

  // æ‰¹é‡åŒæ­¥
  async syncAll(): Promise<void> {
    if (this.isSyncing) return;
    this.isSyncing = true;

    try {
      await this.syncUserData();
      await this.syncEmergencyContacts();
      await this.syncKnockRecords();
      await this.syncDailyStats();
      await this.updateLastSyncTime();
    } finally {
      this.isSyncing = false;
    }
  }
}
```

### 4. æœ¬åœ°æ•°æ®è¿ç§»

#### 4.1 è¿ç§»æµç¨‹

```typescript
// é¦–æ¬¡ç™»å½•æ—¶è¿ç§»æœ¬åœ°æ•°æ®
async function migrateLocalDataToCloud(uid: string): Promise<void> {
  // 1. è¯»å–æ‰€æœ‰æœ¬åœ°æ•°æ®
  const userData = await storage.getUserData();
  const contacts = await storage.getEmergencyContacts();
  const knockRecords = await storage.getKnockRecords();
  const dailyStats = await storage.getDailyStats();

  // 2. ä¸Šä¼ åˆ° Firestore
  await Promise.all([
    uploadUserData(uid, userData),
    uploadContacts(uid, contacts),
    uploadKnockRecords(uid, knockRecords),
    uploadDailyStats(uid, dailyStats)
  ]);

  // 3. æ ‡è®°å·²è¿ç§»
  await storage.set('migrated', true);
  
  // 4. æ˜¾ç¤ºè¿ç§»æˆåŠŸæç¤º
  showNotification('æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯');
}
```

#### 4.2 è¿ç§»æç¤º

```typescript
// ä»…åœ¨æ·»åŠ ç´§æ€¥è”ç³»äººæ—¶æç¤ºç”¨æˆ·ç™»å½•
function shouldPromptLogin(): boolean {
  // åªåœ¨ç”¨æˆ·æœªç™»å½•æ—¶è¿”å› true
  // å…·ä½“æç¤ºæ—¶æœºç”± UI ç»„ä»¶æ§åˆ¶ï¼ˆæ·»åŠ è”ç³»äººæ—¶ï¼‰
  return !authService.isSignedIn();
}
```


### 5. UI è®¾è®¡

#### 5.1 ç™»å½•ç•Œé¢

**Popup é¡µé¢é¡¶éƒ¨ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ æœªç™»å½•                       â”‚
â”‚  [ä½¿ç”¨ Google ç™»å½•] æŒ‰é’®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç™»å½•åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ å¼ ä¸‰                         â”‚
â”‚  ğŸ“§ zhang@gmail.com              â”‚
â”‚  ğŸ”„ æœ€ååŒæ­¥ï¼š2 åˆ†é’Ÿå‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Options é¡µé¢ - è´¦å·è®¾ç½®ï¼š**
```
è´¦å·è®¾ç½®
â”œâ”€â”€ ç”¨æˆ·ä¿¡æ¯
â”‚   â”œâ”€â”€ å¤´åƒ
â”‚   â”œâ”€â”€ æ˜¾ç¤ºåç§°
â”‚   â””â”€â”€ é‚®ç®±
â”œâ”€â”€ æ•°æ®åŒæ­¥
â”‚   â”œâ”€â”€ æœ€ååŒæ­¥æ—¶é—´
â”‚   â”œâ”€â”€ [ç«‹å³åŒæ­¥] æŒ‰é’®
â”‚   â””â”€â”€ è‡ªåŠ¨åŒæ­¥å¼€å…³
â””â”€â”€ è´¦å·æ“ä½œ
    â”œâ”€â”€ [é€€å‡ºç™»å½•] æŒ‰é’®
    â””â”€â”€ [åˆ é™¤è´¦å·] æŒ‰é’®ï¼ˆå±é™©æ“ä½œï¼‰
```

#### 5.2 ç™»å½•æç¤ºæ—¶æœº

**å”¯ä¸€æç¤ºåœºæ™¯ï¼šæ·»åŠ ç´§æ€¥è”ç³»äººæ—¶**

å½“ç”¨æˆ·å°è¯•æ·»åŠ ç´§æ€¥è”ç³»äººæ—¶ï¼Œå¦‚æœæœªç™»å½•ï¼Œæ˜¾ç¤ºæç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ éœ€è¦ç™»å½•æ‰èƒ½å‘é€é‚®ä»¶é€šçŸ¥          â”‚
â”‚                                     â”‚
â”‚ ç™»å½•åæ‚¨å¯ä»¥ï¼š                       â”‚
â”‚ â€¢ å‘é€æ­»äº¡é€šçŸ¥é‚®ä»¶ç»™ç´§æ€¥è”ç³»äºº        â”‚
â”‚ â€¢ æ•°æ®è‡ªåŠ¨å¤‡ä»½åˆ°äº‘ç«¯                 â”‚
â”‚ â€¢ å¤šè®¾å¤‡åŒæ­¥æ•°æ®                     â”‚
â”‚                                     â”‚
â”‚ [ä½¿ç”¨ Google ç™»å½•]  [ç¨åå†è¯´]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡åŸåˆ™ï¼š**
- ä¸åœ¨å…¶ä»–åœ°æ–¹ä¸»åŠ¨æç¤ºç™»å½•
- ä¸å¼ºåˆ¶ç”¨æˆ·ç™»å½•
- æœªç™»å½•æ—¶æ‰€æœ‰æœ¬åœ°åŠŸèƒ½æ­£å¸¸ä½¿ç”¨
- åªåœ¨éœ€è¦äº‘ç«¯åŠŸèƒ½ï¼ˆé‚®ä»¶å‘é€ï¼‰æ—¶æç¤º

#### 5.3 åŒæ­¥çŠ¶æ€æŒ‡ç¤º

```typescript
// åŒæ­¥çŠ¶æ€
enum SyncStatus {
  Idle = 'idle',           // ç©ºé—²
  Syncing = 'syncing',     // åŒæ­¥ä¸­
  Success = 'success',     // åŒæ­¥æˆåŠŸ
  Error = 'error',         // åŒæ­¥å¤±è´¥
  Offline = 'offline'      // ç¦»çº¿
}

// çŠ¶æ€å›¾æ ‡
const statusIcons = {
  idle: 'âšª',
  syncing: 'ğŸ”„',
  success: 'âœ…',
  error: 'âŒ',
  offline: 'ğŸ“´'
};
```

### 6. Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == uid;
    }
    
    // ç”¨æˆ·æ•°æ®
    match /userData/{uid} {
      allow read, write: if request.auth.uid == uid;
    }
    
    // æ•²å‡»è®°å½•
    match /knockRecords/{uid}/records/{recordId} {
      allow read, write: if request.auth.uid == uid;
    }
    
    // æ¯æ—¥ç»Ÿè®¡
    match /dailyStats/{uid}/stats/{date} {
      allow read, write: if request.auth.uid == uid;
    }
    
    // ç´§æ€¥è”ç³»äºº
    match /emergencyContacts/{uid} {
      allow read, write: if request.auth.uid == uid;
    }
  }
}
```

### 7. Firebase é…ç½®æŒ‡å—

#### 7.1 åˆ›å»º Firebase é¡¹ç›®

```bash
# æ­¥éª¤ 1ï¼šè®¿é—® Firebase Console
https://console.firebase.google.com/

# æ­¥éª¤ 2ï¼šåˆ›å»ºæ–°é¡¹ç›®
- é¡¹ç›®åç§°ï¼šalive-checker
- å¯ç”¨ Google Analyticsï¼ˆå¯é€‰ï¼‰

# æ­¥éª¤ 3ï¼šæ·»åŠ  Web åº”ç”¨
- åº”ç”¨æ˜µç§°ï¼šAlive Checker Extension
- ä¸éœ€è¦ Firebase Hosting
- å¤åˆ¶é…ç½®ä¿¡æ¯
```

#### 7.2 å¯ç”¨ Authentication

```bash
# åœ¨ Firebase Console ä¸­ï¼š
1. è¿›å…¥ Authentication
2. ç‚¹å‡»"å¼€å§‹ä½¿ç”¨"
3. å¯ç”¨"Google"ç™»å½•æä¾›å•†
4. é…ç½®é¡¹ç›®å…¬å¼€åç§°å’Œæ”¯æŒé‚®ç®±
5. ä¿å­˜
```

#### 7.3 åˆ›å»º Firestore æ•°æ®åº“

```bash
# åœ¨ Firebase Console ä¸­ï¼š
1. è¿›å…¥ Firestore Database
2. ç‚¹å‡»"åˆ›å»ºæ•°æ®åº“"
3. é€‰æ‹©"ç”Ÿäº§æ¨¡å¼"
4. é€‰æ‹©æ•°æ®åº“ä½ç½®ï¼ˆasia-east1 - å°æ¹¾ï¼‰
5. åˆ›å»º
6. é…ç½®å®‰å…¨è§„åˆ™ï¼ˆè§ä¸Šæ–‡ï¼‰
```

#### 7.4 é…ç½®æ–‡ä»¶

```typescript
// src/shared/config/firebase.ts
export const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "alive-checker.firebaseapp.com",
  projectId: "alive-checker",
  storageBucket: "alive-checker.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abc123"
};

// åˆå§‹åŒ– Firebase
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = getFirestore(app);
```


### 8. é‚®ä»¶å‘é€é›†æˆ

#### 8.1 ç™»å½•æ£€æŸ¥

```typescript
// å‘é€é‚®ä»¶å‰æ£€æŸ¥ç™»å½•çŠ¶æ€
async function sendDeathNotificationEmail(): Promise<void> {
  const user = await authService.getCurrentUser();
  
  if (!user) {
    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
    showLoginPrompt('éœ€è¦ç™»å½•æ‰èƒ½å‘é€é‚®ä»¶é€šçŸ¥');
    return;
  }
  
  // å·²ç™»å½•ï¼Œç»§ç»­å‘é€é‚®ä»¶
  const contacts = await getEmergencyContacts();
  await emailService.sendToContacts(contacts, user);
}
```

#### 8.2 ç”¨æˆ·ä¿¡æ¯ä½¿ç”¨

```typescript
// é‚®ä»¶æ¨¡æ¿ä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯
interface EmailVariables {
  userName: string;        // ä» user.displayName è·å–
  userEmail: string;       // ä» user.email è·å–
  inactiveDays: number;
  currentHP: number;
  lastActiveDate: string;
}

// å‡†å¤‡é‚®ä»¶å˜é‡
function prepareEmailVariables(user: User): EmailVariables {
  return {
    userName: user.displayName || 'ç”¨æˆ·',
    userEmail: user.email,
    inactiveDays: calculateInactiveDays(),
    currentHP: getCurrentHP(),
    lastActiveDate: getLastActiveDate()
  };
}
```

### 9. äº‘ç«¯æ­»äº¡æ£€æµ‹å’Œé‚®ä»¶é€šçŸ¥

#### 9.1 æ¶æ„è®¾è®¡

**æŠ€æœ¯æ–¹æ¡ˆï¼šFirebase Cloud Functions + é‚®ä»¶æœåŠ¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Firebase Cloud                        â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Cloud Scheduler (æ¯å¤© UTC 0:00)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                     â”‚
â”‚                   â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Cloud Function: checkAllUsersStatus()           â”‚  â”‚
â”‚  â”‚  1. æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·æ•°æ®                              â”‚  â”‚
â”‚  â”‚  2. æ£€æŸ¥æ¯ä¸ªç”¨æˆ·çš„ HP å’Œæœªæ´»è·ƒå¤©æ•°                â”‚  â”‚
â”‚  â”‚  3. åˆ¤æ–­æ˜¯å¦"æ­»äº¡"                                â”‚  â”‚
â”‚  â”‚  4. å¦‚æœæ­»äº¡ä¸”æœªå‘é€è¿‡é‚®ä»¶ï¼Œè§¦å‘é‚®ä»¶å‘é€          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                     â”‚
â”‚                   â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Cloud Function: sendDeathNotification()         â”‚  â”‚
â”‚  â”‚  1. è·å–ç”¨æˆ·çš„ç´§æ€¥è”ç³»äºº                          â”‚  â”‚
â”‚  â”‚  2. å‡†å¤‡é‚®ä»¶å†…å®¹ï¼ˆä½¿ç”¨æ¨¡æ¿ï¼‰                      â”‚  â”‚
â”‚  â”‚  3. è°ƒç”¨é‚®ä»¶æœåŠ¡ API å‘é€é‚®ä»¶                     â”‚  â”‚
â”‚  â”‚  4. è®°å½•å‘é€çŠ¶æ€åˆ° Firestore                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                     â”‚
â”‚                   â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  é‚®ä»¶æœåŠ¡ (SendGrid/Mailgun/Gmail SMTP)          â”‚  â”‚
â”‚  â”‚  å‘é€é‚®ä»¶åˆ°ç´§æ€¥è”ç³»äºº                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.2 é‚®ä»¶æœåŠ¡é€‰æ‹©

**æ¨èæ–¹æ¡ˆï¼šSendGridï¼ˆå…è´¹é¢åº¦å……è¶³ï¼‰**

| æœåŠ¡ | å…è´¹é¢åº¦ | ä»·æ ¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|---------|------|------|------|
| **SendGrid** | 100 å°/å¤© | $19.95/æœˆ (40Kå°) | API ç®€å•ï¼Œæ–‡æ¡£å®Œå–„ï¼Œå…è´¹é¢åº¦å……è¶³ | éœ€è¦åŸŸåéªŒè¯ï¼ˆå¯é€‰ï¼‰ |
| Mailgun | 100 å°/å¤© | $35/æœˆ (50Kå°) | åŠŸèƒ½å¼ºå¤§ï¼Œæ—¥å¿—è¯¦ç»† | é…ç½®å¤æ‚ |
| Gmail SMTP | 500 å°/å¤© | å…è´¹ | å®Œå…¨å…è´¹ï¼Œæ— éœ€æ³¨å†Œ | å¯èƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶ |
| AWS SES | 62K å°/æœˆ | $0.10/1000å° | ä¾¿å®œï¼Œå¯é  | éœ€è¦ AWS è´¦å·ï¼Œé…ç½®å¤æ‚ |

**é€‰æ‹© SendGrid çš„ç†ç”±ï¼š**
- å…è´¹é¢åº¦ 100 å°/å¤©ï¼Œè¶³å¤Ÿ 100 ä¸ªç”¨æˆ·ä½¿ç”¨
- API ç®€å•æ˜“ç”¨ï¼Œæ–‡æ¡£å®Œå–„
- æ”¯æŒé‚®ä»¶æ¨¡æ¿å’Œå˜é‡æ›¿æ¢
- æä¾›é‚®ä»¶å‘é€çŠ¶æ€è¿½è¸ª
- æ— éœ€åŸŸåéªŒè¯å³å¯ä½¿ç”¨ï¼ˆä½¿ç”¨ SendGrid åŸŸåï¼‰

#### 9.3 Firestore æ•°æ®æ¨¡å‹æ‰©å±•

```typescript
// deathNotifications/{uid}
interface DeathNotification {
  uid: string;
  isDead: boolean;
  reason: string;
  detectedAt: number;
  emailSent: boolean;
  emailSentAt?: number;
  emailRecipients?: string[];
  emailStatus?: 'pending' | 'sent' | 'failed';
  emailError?: string;
  lastCheckedAt: number;
}

// emailLogs/{logId}
interface EmailLog {
  id: string;
  uid: string;
  recipients: string[];
  subject: string;
  sentAt: number;
  status: 'sent' | 'failed';
  error?: string;
  sendGridMessageId?: string;
}
```

#### 9.4 Cloud Functions å®ç°

**å‡½æ•° 1ï¼šå®šæ—¶æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·çŠ¶æ€**

```typescript
// functions/src/checkAllUsersStatus.ts
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

export const checkAllUsersStatus = functions
  .region('asia-east1')
  .pubsub
  .schedule('0 0 * * *') // æ¯å¤© UTC 0:00 (åŒ—äº¬æ—¶é—´ 8:00)
  .timeZone('Asia/Shanghai')
  .onRun(async (context) => {
    const db = admin.firestore();
    
    // 1. è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
    const usersSnapshot = await db.collection('userData').get();
    
    console.log(`Checking ${usersSnapshot.size} users...`);
    
    // 2. æ£€æŸ¥æ¯ä¸ªç”¨æˆ·
    const checkPromises = usersSnapshot.docs.map(async (doc) => {
      const userData = doc.data();
      const uid = doc.id;
      
      // 3. åˆ¤æ–­æ˜¯å¦æ­»äº¡
      const deathStatus = await checkUserDeathStatus(userData);
      
      // 4. ä¿å­˜æ£€æµ‹ç»“æœ
      await db.collection('deathNotifications').doc(uid).set({
        uid,
        isDead: deathStatus.isDead,
        reason: deathStatus.reason,
        detectedAt: Date.now(),
        lastCheckedAt: Date.now(),
        emailSent: false
      }, { merge: true });
      
      // 5. å¦‚æœæ­»äº¡ä¸”æœªå‘é€è¿‡é‚®ä»¶ï¼Œè§¦å‘é‚®ä»¶å‘é€
      if (deathStatus.isDead) {
        const notification = await db.collection('deathNotifications').doc(uid).get();
        const notificationData = notification.data();
        
        if (!notificationData?.emailSent) {
          console.log(`User ${uid} is dead, sending notification...`);
          await sendDeathNotification(uid, userData);
        }
      }
    });
    
    await Promise.all(checkPromises);
    
    console.log('All users checked successfully');
  });

// æ£€æŸ¥ç”¨æˆ·æ­»äº¡çŠ¶æ€
async function checkUserDeathStatus(userData: any): Promise<{
  isDead: boolean;
  reason: string;
}> {
  // è·å–æ­»äº¡æ£€æµ‹é…ç½®ï¼ˆä» Firestore æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
  const config = {
    hpThreshold: 0,
    inactivityThreshold: 30
  };
  
  // æ£€æŸ¥ HP
  if (userData.hp <= config.hpThreshold) {
    return {
      isDead: true,
      reason: `HP ä½äºé˜ˆå€¼ (${userData.hp} <= ${config.hpThreshold})`
    };
  }
  
  // æ£€æŸ¥æœªæ´»è·ƒå¤©æ•°
  const inactiveDays = Math.floor(
    (Date.now() - userData.lastKnockTime) / (1000 * 60 * 60 * 24)
  );
  
  if (inactiveDays >= config.inactivityThreshold) {
    return {
      isDead: true,
      reason: `æœªæ´»è·ƒå¤©æ•°è¶…è¿‡é˜ˆå€¼ (${inactiveDays} >= ${config.inactivityThreshold})`
    };
  }
  
  return {
    isDead: false,
    reason: 'çŠ¶æ€æ­£å¸¸'
  };
}
```

**å‡½æ•° 2ï¼šå‘é€æ­»äº¡é€šçŸ¥é‚®ä»¶**

```typescript
// functions/src/sendDeathNotification.ts
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as sgMail from '@sendgrid/mail';

// åˆå§‹åŒ– SendGrid
sgMail.setApiKey(functions.config().sendgrid.key);

async function sendDeathNotification(uid: string, userData: any): Promise<void> {
  const db = admin.firestore();
  
  try {
    // 1. è·å–ç´§æ€¥è”ç³»äºº
    const contactsDoc = await db.collection('emergencyContacts').doc(uid).get();
    const contactsData = contactsDoc.data();
    
    if (!contactsData || !contactsData.contacts || contactsData.contacts.length === 0) {
      console.log(`No emergency contacts found for user ${uid}`);
      return;
    }
    
    // 2. æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå–å‰ 5 ä¸ª
    const contacts = contactsData.contacts
      .sort((a: any, b: any) => a.priority - b.priority)
      .slice(0, 5);
    
    const recipients = contacts.map((c: any) => c.email);
    
    // 3. å‡†å¤‡é‚®ä»¶å†…å®¹
    const emailContent = prepareEmailContent(userData);
    
    // 4. å‘é€é‚®ä»¶
    const msg = {
      to: recipients,
      from: 'noreply@alive-checker.com', // éœ€è¦åœ¨ SendGrid éªŒè¯
      subject: emailContent.subject,
      text: emailContent.textBody,
      html: emailContent.htmlBody
    };
    
    const response = await sgMail.sendMultiple(msg);
    
    console.log(`Email sent to ${recipients.length} recipients for user ${uid}`);
    
    // 5. æ›´æ–°å‘é€çŠ¶æ€
    await db.collection('deathNotifications').doc(uid).update({
      emailSent: true,
      emailSentAt: Date.now(),
      emailRecipients: recipients,
      emailStatus: 'sent'
    });
    
    // 6. è®°å½•é‚®ä»¶æ—¥å¿—
    await db.collection('emailLogs').add({
      uid,
      recipients,
      subject: emailContent.subject,
      sentAt: Date.now(),
      status: 'sent',
      sendGridMessageId: response[0].headers['x-message-id']
    });
    
  } catch (error) {
    console.error(`Failed to send email for user ${uid}:`, error);
    
    // è®°å½•å¤±è´¥çŠ¶æ€
    await db.collection('deathNotifications').doc(uid).update({
      emailStatus: 'failed',
      emailError: error.message
    });
    
    await db.collection('emailLogs').add({
      uid,
      recipients: [],
      subject: '',
      sentAt: Date.now(),
      status: 'failed',
      error: error.message
    });
  }
}

// å‡†å¤‡é‚®ä»¶å†…å®¹
function prepareEmailContent(userData: any): {
  subject: string;
  textBody: string;
  htmlBody: string;
} {
  const userName = userData.displayName || 'ç”¨æˆ·';
  const inactiveDays = Math.floor(
    (Date.now() - userData.lastKnockTime) / (1000 * 60 * 60 * 24)
  );
  const lastActiveDate = new Date(userData.lastKnockTime).toLocaleString('zh-CN');
  const currentDate = new Date().toLocaleString('zh-CN');
  
  // ä½¿ç”¨ç°æœ‰çš„é‚®ä»¶æ¨¡æ¿
  // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥å¤ç”¨ src/shared/templates/death-notification-email.ts
  
  const subject = `âš ï¸ é‡è¦é€šçŸ¥ï¼š${userName} å·²ç» ${inactiveDays} å¤©æ²¡æœ‰æ´»è·ƒ`;
  
  const textBody = `
âš ï¸ é‡è¦é€šçŸ¥

æ‚¨å¥½ï¼Œ

æˆ‘ä»¬æ³¨æ„åˆ° ${userName} å·²ç» ${inactiveDays} å¤©æ²¡æœ‰æ´»è·ƒäº†ã€‚
æ ¹æ®é¢„å…ˆè®¾å®šçš„è§„åˆ™ï¼Œç³»ç»Ÿåˆ¤å®šå¯èƒ½éœ€è¦æ‚¨çš„å…³æ³¨ã€‚

è¯¦ç»†ä¿¡æ¯ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æœ€åæ´»è·ƒæ—¶é—´ï¼š${lastActiveDate}
æ£€æµ‹æ—¶é—´ï¼š${currentDate}
æœªæ´»è·ƒå¤©æ•°ï¼š${inactiveDays} å¤©
åŠŸå¾·å€¼ï¼š${userData.merit}
ç”Ÿå‘½å€¼ï¼š${userData.hp}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ è¿™æ˜¯ä»€ä¹ˆï¼Ÿ
è¿™æ˜¯ä¸€å°è‡ªåŠ¨å‘é€çš„å…³æ€€æé†’é‚®ä»¶ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚
å¦‚æœæ‚¨æ‹…å¿ƒå¯¹æ–¹çš„å®‰å…¨ï¼Œå»ºè®®å°½å¿«è”ç³»ç¡®è®¤ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ­¤é‚®ä»¶ç”±"è¿˜æ´»ç€å—"æ‰©å±•è‡ªåŠ¨å‘é€
Â© 2025 è¿˜æ´»ç€å— | å…³å¿ƒæ¯ä¸€ä¸ªç”Ÿå‘½
  `.trim();
  
  const htmlBody = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 8px; }
    .container { background-color: #ffffff; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { text-align: center; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; margin-bottom: 30px; }
    .header h1 { color: #d32f2f; margin: 0; font-size: 24px; }
    .message { background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; }
    .details { background-color: #f5f5f5; padding: 15px; border-radius: 4px; margin: 20px 0; }
    .details-item { margin: 8px 0; display: flex; justify-content: space-between; }
    .details-label { font-weight: bold; color: #666; }
    .details-value { color: #333; }
    .note { background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 20px 0; font-size: 14px; }
    .footer { text-align: center; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>âš ï¸ é‡è¦é€šçŸ¥</h1>
    </div>
    <div class="content">
      <div class="greeting">æ‚¨å¥½ï¼Œ</div>
      <div class="message">
        <p>æˆ‘ä»¬æ³¨æ„åˆ° <strong>${userName}</strong> å·²ç» <strong>${inactiveDays}</strong> å¤©æ²¡æœ‰æ´»è·ƒäº†ã€‚</p>
        <p>æ ¹æ®é¢„å…ˆè®¾å®šçš„è§„åˆ™ï¼Œç³»ç»Ÿåˆ¤å®šå¯èƒ½éœ€è¦æ‚¨çš„å…³æ³¨ã€‚</p>
      </div>
      <div class="details">
        <div class="details-item">
          <span class="details-label">æœ€åæ´»è·ƒæ—¶é—´ï¼š</span>
          <span class="details-value">${lastActiveDate}</span>
        </div>
        <div class="details-item">
          <span class="details-label">æ£€æµ‹æ—¶é—´ï¼š</span>
          <span class="details-value">${currentDate}</span>
        </div>
        <div class="details-item">
          <span class="details-label">æœªæ´»è·ƒå¤©æ•°ï¼š</span>
          <span class="details-value">${inactiveDays} å¤©</span>
        </div>
        <div class="details-item">
          <span class="details-label">åŠŸå¾·å€¼ï¼š</span>
          <span class="details-value">${userData.merit}</span>
        </div>
        <div class="details-item">
          <span class="details-label">ç”Ÿå‘½å€¼ï¼š</span>
          <span class="details-value">${userData.hp}</span>
        </div>
      </div>
      <div class="note">
        <p><strong>ğŸ’¡ è¿™æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
        <p>è¿™æ˜¯ä¸€å°è‡ªåŠ¨å‘é€çš„å…³æ€€æé†’é‚®ä»¶ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚å¦‚æœæ‚¨æ‹…å¿ƒå¯¹æ–¹çš„å®‰å…¨ï¼Œå»ºè®®å°½å¿«è”ç³»ç¡®è®¤ã€‚</p>
      </div>
    </div>
    <div class="footer">
      <p>æ­¤é‚®ä»¶ç”±"è¿˜æ´»ç€å—"æ‰©å±•è‡ªåŠ¨å‘é€</p>
      <p>Â© 2025 è¿˜æ´»ç€å— | å…³å¿ƒæ¯ä¸€ä¸ªç”Ÿå‘½</p>
    </div>
  </div>
</body>
</html>
  `.trim();
  
  return { subject, textBody, htmlBody };
}
```

#### 9.5 éƒ¨ç½² Cloud Functions

```bash
# 1. å®‰è£… Firebase CLI
npm install -g firebase-tools

# 2. ç™»å½• Firebase
firebase login

# 3. åˆå§‹åŒ– Functions
firebase init functions
# é€‰æ‹© TypeScript
# å®‰è£…ä¾èµ–

# 4. å®‰è£… SendGrid SDK
cd functions
npm install @sendgrid/mail

# 5. é…ç½® SendGrid API Key
firebase functions:config:set sendgrid.key="YOUR_SENDGRID_API_KEY"

# 6. éƒ¨ç½² Functions
firebase deploy --only functions

# 7. æŸ¥çœ‹æ—¥å¿—
firebase functions:log
```

#### 9.6 SendGrid é…ç½®

```bash
# 1. æ³¨å†Œ SendGrid è´¦å·
https://signup.sendgrid.com/

# 2. åˆ›å»º API Key
Settings > API Keys > Create API Key
- Name: alive-checker-cloud-functions
- Permissions: Full Access (æˆ– Mail Send)
- å¤åˆ¶ API Key

# 3. éªŒè¯å‘ä»¶äººé‚®ç®±ï¼ˆå¯é€‰ï¼‰
Settings > Sender Authentication > Single Sender Verification
- å¡«å†™å‘ä»¶äººä¿¡æ¯
- éªŒè¯é‚®ç®±

# 4. é…ç½®åˆ° Firebase
firebase functions:config:set sendgrid.key="SG.xxx..."
```

#### 9.7 æ£€æŸ¥é¢‘ç‡é…ç½®

**æ¨èï¼šæ¯å¤©æ£€æŸ¥ä¸€æ¬¡ï¼ˆUTC 0:00 / åŒ—äº¬æ—¶é—´ 8:00ï¼‰**

ç†ç”±ï¼š
- æ­»äº¡æ£€æµ‹ä¸éœ€è¦å®æ—¶æ€§ï¼Œæ¯å¤©æ£€æŸ¥ä¸€æ¬¡è¶³å¤Ÿ
- å‡å°‘ Cloud Functions è°ƒç”¨æ¬¡æ•°ï¼ŒèŠ‚çœæˆæœ¬
- é¿å…é¢‘ç¹å‘é€é‚®ä»¶æ‰“æ‰°è”ç³»äºº

å¯é€‰é¢‘ç‡ï¼š
- æ¯ 12 å°æ—¶ï¼š`'0 */12 * * *'`
- æ¯ 6 å°æ—¶ï¼š`'0 */6 * * *'`
- æ¯å°æ—¶ï¼š`'0 * * * *'`ï¼ˆä¸æ¨èï¼Œæˆæœ¬é«˜ï¼‰

#### 9.8 é˜²æ­¢é‡å¤å‘é€

```typescript
// æ£€æŸ¥æ˜¯å¦å·²å‘é€è¿‡é‚®ä»¶
async function shouldSendEmail(uid: string): Promise<boolean> {
  const db = admin.firestore();
  const notification = await db.collection('deathNotifications').doc(uid).get();
  const data = notification.data();
  
  // å¦‚æœå·²å‘é€è¿‡ï¼Œä¸å†å‘é€
  if (data?.emailSent) {
    console.log(`Email already sent for user ${uid} at ${new Date(data.emailSentAt).toISOString()}`);
    return false;
  }
  
  return true;
}

// ç”¨æˆ·æ¢å¤æ´»è·ƒåï¼Œé‡ç½®å‘é€çŠ¶æ€
async function resetEmailSentStatus(uid: string): Promise<void> {
  const db = admin.firestore();
  await db.collection('deathNotifications').doc(uid).update({
    isDead: false,
    emailSent: false,
    emailSentAt: admin.firestore.FieldValue.delete(),
    emailRecipients: admin.firestore.FieldValue.delete()
  });
}
```

#### 9.9 æˆæœ¬ä¼°ç®—

**SendGrid å…è´¹é¢åº¦ï¼š100 å°/å¤©**

å‡è®¾åœºæ™¯ï¼š
- ç”¨æˆ·æ•°ï¼š1000
- æ­»äº¡ç‡ï¼š1%ï¼ˆ10 ä¸ªç”¨æˆ·ï¼‰
- æ¯ä¸ªç”¨æˆ· 5 ä¸ªè”ç³»äºº
- æ¯å¤©å‘é€ï¼š10 Ã— 5 = 50 å°é‚®ä»¶

**ç»“è®ºï¼šå…è´¹é¢åº¦å®Œå…¨å¤Ÿç”¨**

å¦‚æœè¶…å‡ºå…è´¹é¢åº¦ï¼š
- SendGrid Essentials: $19.95/æœˆï¼ˆ40,000 å°ï¼‰
- å¹³å‡æˆæœ¬ï¼š$0.0005/å°

**Cloud Functions æˆæœ¬ï¼š**
- å…è´¹é¢åº¦ï¼š200 ä¸‡æ¬¡è°ƒç”¨/æœˆ
- æ¯å¤©æ£€æŸ¥ 1000 ç”¨æˆ· = 1000 æ¬¡è°ƒç”¨
- æ¯æœˆ = 30,000 æ¬¡è°ƒç”¨
- **å®Œå…¨åœ¨å…è´¹é¢åº¦å†…**

#### 9.10 ç›‘æ§å’Œæ—¥å¿—

```typescript
// æ·»åŠ è¯¦ç»†æ—¥å¿—
console.log('[CheckUsers] Starting check for all users');
console.log(`[CheckUsers] Found ${usersSnapshot.size} users`);
console.log(`[CheckUsers] User ${uid} is dead: ${deathStatus.isDead}`);
console.log(`[SendEmail] Sending to ${recipients.length} recipients`);
console.log(`[SendEmail] Email sent successfully, message ID: ${messageId}`);
console.error(`[SendEmail] Failed to send email:`, error);

// åœ¨ Firebase Console æŸ¥çœ‹æ—¥å¿—
// Functions > Logs
// å¯ä»¥æŒ‰æ—¶é—´ã€ä¸¥é‡ç¨‹åº¦ã€å‡½æ•°åç­›é€‰
```

## æŠ€æœ¯å®ç°

### é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ firebase.ts           # Firebase é…ç½®
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth-service.ts       # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ sync-service.ts       # åŒæ­¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ firestore-service.ts  # Firestore æ“ä½œ
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ auth.ts               # è®¤è¯ç›¸å…³ç±»å‹
â”œâ”€â”€ popup/
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ LoginButton.tsx       # ç™»å½•æŒ‰é’®
â”‚       â””â”€â”€ UserProfile.tsx       # ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
â”œâ”€â”€ options/
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ AccountSettings.tsx   # è´¦å·è®¾ç½®é¡µé¢
â”‚       â””â”€â”€ SyncStatus.tsx        # åŒæ­¥çŠ¶æ€ç»„ä»¶
â””â”€â”€ background/
    â””â”€â”€ services/
        â””â”€â”€ sync-scheduler.ts     # åŒæ­¥è°ƒåº¦å™¨
```

### ä¾èµ–å®‰è£…

```bash
# å®‰è£… Firebase SDK
npm install firebase

# ç±»å‹å®šä¹‰å·²åŒ…å«åœ¨ firebase åŒ…ä¸­
```

### manifest.json æ›´æ–°

```json
{
  "permissions": [
    "storage",
    "notifications",
    "alarms",
    "identity"  // æ–°å¢ï¼šç”¨äº Google ç™»å½•
  ],
  "host_permissions": [
    "https://*.firebaseapp.com/*",
    "https://*.googleapis.com/*"
  ],
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self'"
  }
}
```

## å¼€å‘æŒ‡å—

### 1. æœ¬åœ°å¼€å‘è®¾ç½®

```bash
# 1. åˆ›å»º Firebase é¡¹ç›®ï¼ˆè§ä¸Šæ–‡ï¼‰

# 2. å¤åˆ¶é…ç½®åˆ°é¡¹ç›®
# åˆ›å»º src/shared/config/firebase.ts
# ç²˜è´´ Firebase é…ç½®

# 3. å®‰è£…ä¾èµ–
npm install

# 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 5. åœ¨ Chrome ä¸­åŠ è½½æ’ä»¶æµ‹è¯•
```

### 2. æµ‹è¯•ç™»å½•æµç¨‹

```bash
# 1. ç‚¹å‡»"ä½¿ç”¨ Google ç™»å½•"
# 2. é€‰æ‹© Google è´¦å·
# 3. æˆæƒåº”ç”¨
# 4. æŸ¥çœ‹ Firestore ä¸­æ˜¯å¦åˆ›å»ºäº†ç”¨æˆ·æ•°æ®
# 5. æŸ¥çœ‹æœ¬åœ°æ•°æ®æ˜¯å¦å·²è¿ç§»
```

### 3. æµ‹è¯•åŒæ­¥åŠŸèƒ½

```bash
# 1. ç™»å½•åæ•²å‡»æœ¨é±¼
# 2. æŸ¥çœ‹ Firestore ä¸­æ•°æ®æ˜¯å¦æ›´æ–°
# 3. åœ¨å¦ä¸€å°è®¾å¤‡ç™»å½•åŒä¸€è´¦å·
# 4. æŸ¥çœ‹æ•°æ®æ˜¯å¦åŒæ­¥
```

### 4. æµ‹è¯•ç¦»çº¿æ¨¡å¼

```bash
# 1. æ–­å¼€ç½‘ç»œ
# 2. æ•²å‡»æœ¨é±¼ï¼ˆåº”è¯¥æ­£å¸¸å·¥ä½œï¼‰
# 3. æ¢å¤ç½‘ç»œ
# 4. æŸ¥çœ‹æ•°æ®æ˜¯å¦è‡ªåŠ¨åŒæ­¥
```

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Google è´¦å·ç™»å½•
- [ ] ç™»å½•åæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€åç§°ã€é‚®ç®±ï¼‰
- [ ] é¦–æ¬¡ç™»å½•æ—¶æœ¬åœ°æ•°æ®è‡ªåŠ¨è¿ç§»åˆ°äº‘ç«¯
- [ ] æ•²å‡»æœ¨é±¼åæ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
- [ ] æ·»åŠ ç´§æ€¥è”ç³»äººåæ•°æ®è‡ªåŠ¨åŒæ­¥
- [ ] åœ¨è®¾ç½®é¡µé¢å¯ä»¥æ‰‹åŠ¨è§¦å‘åŒæ­¥
- [ ] æ˜¾ç¤ºæœ€ååŒæ­¥æ—¶é—´
- [ ] ç¦»çº¿æ—¶æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ä½¿ç”¨
- [ ] è”ç½‘åè‡ªåŠ¨åŒæ­¥ç¦»çº¿æœŸé—´çš„æ•°æ®
- [ ] æ·»åŠ ç´§æ€¥è”ç³»äººæ—¶æç¤ºç™»å½•ï¼ˆæœªç™»å½•æ—¶ï¼‰
- [ ] ç‚¹å‡»"ç¨åå†è¯´"å¯ä»¥ç»§ç»­æ·»åŠ è”ç³»äºº
- [ ] æœªç™»å½•æ—¶å‘é€é‚®ä»¶ä¼šè¢«é˜»æ­¢ï¼ˆé™é»˜å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ï¼‰
- [ ] ç”¨æˆ·å¯ä»¥é€€å‡ºç™»å½•
- [ ] é€€å‡ºç™»å½•åæœ¬åœ°æ•°æ®ä¿ç•™
- [ ] **Cloud Functions å®šæ—¶æ£€æŸ¥åŠŸèƒ½æ­£å¸¸è¿è¡Œ**
- [ ] **æ£€æµ‹åˆ°æ­»äº¡ç”¨æˆ·æ—¶è‡ªåŠ¨å‘é€é‚®ä»¶**
- [ ] **é‚®ä»¶æˆåŠŸé€è¾¾ç´§æ€¥è”ç³»äººï¼ˆæœ€å¤š 5 ä¸ªï¼‰**
- [ ] **ä¸ä¼šé‡å¤å‘é€é‚®ä»¶ç»™åŒä¸€ç”¨æˆ·**
- [ ] **ç”¨æˆ·æ¢å¤æ´»è·ƒåå¯ä»¥å†æ¬¡è§¦å‘é‚®ä»¶**
- [ ] **é‚®ä»¶æ—¥å¿—æ­£ç¡®è®°å½•åˆ° Firestore**

### æ€§èƒ½éªŒæ”¶
- [ ] ç™»å½•å“åº”æ—¶é—´ < 3 ç§’
- [ ] æ•°æ®åŒæ­¥å»¶è¿Ÿ < 5 ç§’
- [ ] ç¦»çº¿æ“ä½œæ— å»¶è¿Ÿ
- [ ] **Cloud Functions æ‰§è¡Œæ—¶é—´ < 60 ç§’**
- [ ] **é‚®ä»¶å‘é€å»¶è¿Ÿ < 10 ç§’**

### å®‰å…¨éªŒæ”¶
- [ ] ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- [ ] Firestore Security Rules æ­£ç¡®é…ç½®
- [ ] æ•æ„Ÿä¿¡æ¯ä¸åœ¨å®¢æˆ·ç«¯æ˜æ–‡å­˜å‚¨
- [ ] **Cloud Functions åªèƒ½è®¿é—®æˆæƒæ•°æ®**
- [ ] **SendGrid API Key å®‰å…¨å­˜å‚¨åœ¨ Firebase Config**
- [ ] **é‚®ä»¶å†…å®¹ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯**

## ä¾èµ–

- M5ï¼šæ­»äº¡é€šçŸ¥ç³»ç»Ÿï¼ˆé‚®ä»¶å‘é€åŠŸèƒ½ï¼‰
- Firebase é¡¹ç›®ï¼ˆå…è´¹è®¡åˆ’ï¼‰
- Google Cloud è´¦å·

## é£é™©

### æŠ€æœ¯é£é™©

1. **Firebase é…é¢é™åˆ¶**
   - **é£é™©**ï¼šå…è´¹é¢åº¦ä¸å¤Ÿç”¨
   - **åº”å¯¹**ï¼šç›‘æ§ä½¿ç”¨é‡ï¼Œä¼˜åŒ–æŸ¥è¯¢æ¬¡æ•°
   - **å¤‡é€‰**ï¼šå‡çº§åˆ° Blaze è®¡åˆ’ï¼ˆæŒ‰éœ€ä»˜è´¹ï¼‰

2. **æ•°æ®åŒæ­¥å†²çª**
   - **é£é™©**ï¼šå¤šè®¾å¤‡åŒæ—¶ä¿®æ”¹æ•°æ®
   - **åº”å¯¹**ï¼šä½¿ç”¨æ—¶é—´æˆ³è§£å†³å†²çªï¼Œè®°å½•åŒæ­¥æ—¥å¿—

3. **Chrome Extension é™åˆ¶**
   - **é£é™©**ï¼šService Worker ç”Ÿå‘½å‘¨æœŸé™åˆ¶
   - **åº”å¯¹**ï¼šä½¿ç”¨ Chrome Alarms å®šæ—¶å”¤é†’

4. **SendGrid é…é¢é™åˆ¶**
   - **é£é™©**ï¼šå…è´¹é¢åº¦ 100 å°/å¤©å¯èƒ½ä¸å¤Ÿ
   - **åº”å¯¹**ï¼š
     - ä¼˜åŒ–æ£€æŸ¥é¢‘ç‡ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
     - é™åˆ¶æ¯ä¸ªç”¨æˆ·æœ€å¤š 5 ä¸ªè”ç³»äºº
     - ç›‘æ§å‘é€é‡
     - å¿…è¦æ—¶å‡çº§åˆ°ä»˜è´¹è®¡åˆ’
   - **æˆæœ¬**ï¼š$19.95/æœˆï¼ˆ40,000 å°ï¼‰

5. **Cloud Functions å†·å¯åŠ¨**
   - **é£é™©**ï¼šé¦–æ¬¡è°ƒç”¨å¯èƒ½è¾ƒæ…¢ï¼ˆ5-10 ç§’ï¼‰
   - **åº”å¯¹**ï¼š
     - ä½¿ç”¨å®šæ—¶è§¦å‘ä¿æŒæ¸©æš–
     - ä¼˜åŒ–å‡½æ•°ä»£ç å‡å°‘ä¾èµ–
     - æ¥å—å†·å¯åŠ¨å»¶è¿Ÿï¼ˆéå®æ—¶åœºæ™¯ï¼‰

6. **é‚®ä»¶é€è¾¾ç‡**
   - **é£é™©**ï¼šé‚®ä»¶å¯èƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶
   - **åº”å¯¹**ï¼š
     - ä½¿ç”¨ SendGrid éªŒè¯åŸŸåï¼ˆå¯é€‰ï¼‰
     - ä¼˜åŒ–é‚®ä»¶å†…å®¹å’Œæ ¼å¼
     - æ·»åŠ é€€è®¢é“¾æ¥ï¼ˆå¯é€‰ï¼‰
     - ç›‘æ§ SendGrid é€è¾¾ç‡æŠ¥å‘Š

### äº§å“é£é™©

1. **ç”¨æˆ·éšç§æ‹…å¿§**
   - **é£é™©**ï¼šç”¨æˆ·æ‹…å¿ƒæ•°æ®å®‰å…¨
   - **åº”å¯¹**ï¼š
     - æ˜ç¡®éšç§æ”¿ç­–
     - è¯´æ˜æ•°æ®ç”¨é€”
     - æä¾›æ•°æ®å¯¼å‡ºå’Œåˆ é™¤åŠŸèƒ½

2. **ç™»å½•é—¨æ§›**
   - **é£é™©**ï¼šå¼ºåˆ¶ç™»å½•å¯èƒ½æµå¤±ç”¨æˆ·
   - **åº”å¯¹**ï¼š
     - ä¸å¼ºåˆ¶ç™»å½•ï¼Œæœ¬åœ°åŠŸèƒ½å®Œæ•´å¯ç”¨
     - åœ¨åˆé€‚æ—¶æœºæ¸©å’Œæç¤º
     - è¯´æ˜ç™»å½•çš„å¥½å¤„ï¼ˆæ•°æ®å¤‡ä»½ã€é‚®ä»¶é€šçŸ¥ï¼‰

3. **è¯¯æŠ¥é—®é¢˜**
   - **é£é™©**ï¼šç”¨æˆ·æ­£å¸¸ä½†è¢«åˆ¤å®šä¸º"æ­»äº¡"
   - **åº”å¯¹**ï¼š
     - è®¾ç½®åˆç†çš„é˜ˆå€¼ï¼ˆ30 å¤©æœªæ´»è·ƒï¼‰
     - é‚®ä»¶å†…å®¹æ¸©å’Œï¼Œä¸ä½¿ç”¨"æ­»äº¡"ç­‰æ•æ„Ÿè¯
     - æä¾›ç”¨æˆ·åé¦ˆæœºåˆ¶
     - å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ£€æµ‹è§„åˆ™

4. **è”ç³»äººéªšæ‰°**
   - **é£é™©**ï¼šé¢‘ç¹å‘é€é‚®ä»¶æ‰“æ‰°è”ç³»äºº
   - **åº”å¯¹**ï¼š
     - æ¯ä¸ªç”¨æˆ·åªå‘é€ä¸€æ¬¡ï¼ˆç›´åˆ°æ¢å¤æ´»è·ƒï¼‰
     - æ£€æŸ¥é¢‘ç‡è®¾ç½®ä¸ºæ¯å¤©ä¸€æ¬¡
     - é‚®ä»¶å†…å®¹æ¸…æ™°è¯´æ˜æ˜¯è‡ªåŠ¨æé†’

## åç»­ä¼˜åŒ–

### Phase 2ï¼ˆå¯é€‰ï¼‰
- æ·»åŠ é‚®ç®±å¯†ç ç™»å½•
- æ·»åŠ å…¶ä»–ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆGitHubã€Microsoftï¼‰
- æ•°æ®åŠ å¯†å­˜å‚¨

### Phase 3ï¼ˆé˜¶æ®µ 3ï¼‰
- å¥½å‹ç³»ç»Ÿ
- æ’è¡Œæ¦œ
- ç¤¾äº¤äº’åŠ¨

## å‚è€ƒèµ„æ–™

### Firebase æ–‡æ¡£
- [Firebase Authentication](https://firebase.google.com/docs/auth)
- [Firestore å…¥é—¨](https://firebase.google.com/docs/firestore/quickstart)
- [Security Rules](https://firebase.google.com/docs/firestore/security/get-started)

### Chrome Extension
- [Identity API](https://developer.chrome.com/docs/extensions/reference/identity/)
- [Storage API](https://developer.chrome.com/docs/extensions/reference/storage/)

### æœ€ä½³å®è·µ
- [Offline-First Architecture](https://firebase.google.com/docs/firestore/manage-data/enable-offline)
- [Data Sync Patterns](https://firebase.google.com/docs/firestore/solutions/sync)

---

**å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿè®©æˆ‘ä»¬ä¸º"è¿˜æ´»ç€å—"æ·»åŠ äº‘ç«¯è¶…èƒ½åŠ›ï¼â˜ï¸**

